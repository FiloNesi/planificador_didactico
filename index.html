/***** CONFIG *****/
const SPREADSHEET_ID = ''; // opcional: pega aquí el ID de tu Sheet. Si lo dejas vacío, se creará uno nuevo la primera vez.
const SHEET_NAME = 'Sessions';

/***** CORE *****/
function doGet(e) {
  return _json({ success: true, data: 'OK' });
}

function doPost(e) {
  try {
    let payload = {};
    if (e.postData && e.postData.contents) {
      // Llega como text/plain con JSON en el cuerpo
      payload = JSON.parse(e.postData.contents);
    } else if (e.parameter && e.parameter.action) {
      payload = e.parameter; // por si usas x-www-form-urlencoded
    }

    const action = payload.action;
    if (!action) return _jsonError('Falta "action"');

    switch (action) {
      case 'getSessions':
        return _json({ success: true, data: getSessions_() });

      case 'saveSession':
        if (!payload.data || typeof payload.data !== 'object') {
          return _jsonError('Falta "data" con la sesión');
        }
        return _json({ success: true, data: saveSession_(payload.data) });

      case 'deleteSession':
        if (!payload.id) return _jsonError('Falta "id"');
        deleteSession_(payload.id);
        return _json({ success: true, data: true });

      default:
        return _jsonError(`Acción no reconocida: ${action}`);
    }
  } catch (err) {
    return _json({ success: false, message: String(err) });
  }
}

/***** IMPLEMENTACIÓN *****/
function getSessions_() {
  const sh = _getSheet_();
  const values = sh.getDataRange().getValues();
  if (values.length < 2) return [];
  const headers = values[0];
  const rows = values.slice(1);

  const COL_ID = headers.indexOf('id');
  const COL_CREATED = headers.indexOf('createdAt');
  const COL_UPDATED = headers.indexOf('updatedAt');
  const COL_DATA = headers.indexOf('data');

  return rows
    .filter(r => r[COL_ID]) // filas válidas
    .map(r => {
      const obj = JSON.parse(r[COL_DATA] || '{}');
      obj.id = r[COL_ID];
      obj.createdAt = r[COL_CREATED];
      obj.updatedAt = r[COL_UPDATED];
      return obj;
    });
}

function saveSession_(data) {
  const sh = _getSheet_();
  const headers = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0];

  const COL_ID = headers.indexOf('id') + 1;
  const COL_CREATED = headers.indexOf('createdAt') + 1;
  const COL_UPDATED = headers.indexOf('updatedAt') + 1;
  const COL_DATA = headers.indexOf('data') + 1;

  const now = new Date();
  let id = data.id || null;

  if (id) {
    // actualizar
    const row = _findRowById_(sh, id);
    if (!row) throw new Error('No se encontró la sesión con ese id');
    sh.getRange(row, COL_DATA).setValue(JSON.stringify(_stripId_(data)));
    sh.getRange(row, COL_UPDATED).setValue(now);
    return { id, updatedAt: now };
  } else {
    // crear
    id = Utilities.getUuid();
    const row = sh.getLastRow() + 1;
    sh.getRange(row, COL_ID, 1, 4).setValues([[id, now, now, JSON.stringify(_stripId_(data))]]);
    return { id, createdAt: now, updatedAt: now };
  }
}

function deleteSession_(id) {
  const sh = _getSheet_();
  const row = _findRowById_(sh, id);
  if (!row) throw new Error('No se encontró la sesión con ese id');
  sh.deleteRow(row);
}

/***** HELPERS *****/
function _json(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
function _jsonError(msg) {
  return _json({ success: false, message: msg });
}

function _getSheet_() {
  let ss;
  if (SPREADSHEET_ID) {
    ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  } else {
    // crea uno la primera vez si no hay ID
    const userProps = PropertiesService.getUserProperties();
    const storedId = userProps.getProperty('PD_SHEET_ID');
    if (storedId) {
      ss = SpreadsheetApp.openById(storedId);
    } else {
      ss = SpreadsheetApp.create('Planificador Didáctico - Sessions');
      userProps.setProperty('PD_SHEET_ID', ss.getId());
    }
  }
  let sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) {
    sh = ss.insertSheet(SHEET_NAME);
    sh.getRange(1,1,1,4).setValues([['id','createdAt','updatedAt','data']]);
    sh.getRange('A:D').setNumberFormat('@STRING@'); // texto por defecto
  }
  return sh;
}

function _findRowById_(sh, id) {
  const data = sh.getRange(2, 1, sh.getLastRow() - 1, 1).getValues();
  for (let i = 0; i < data.length; i++) {
    if (String(data[i][0]) === String(id)) return i + 2; // +2 por encabezado
  }
  return null;
}

function _stripId_(obj) {
  const clone = JSON.parse(JSON.stringify(obj));
  delete clone.id;
  delete clone.createdAt;
  delete clone.updatedAt;
  return clone;
}
