<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Didáctico de Filosofía</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        select[multiple] { padding: 0.5rem; }
        .checkbox-group { max-height: 20rem; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app-container" class="flex flex-col h-screen">
        <header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
            <h1 class="text-2xl font-bold text-slate-700">Planificador Didáctico</h1>
        </header>
        <main class="flex-grow flex flex-col md:flex-row gap-4 p-4 overflow-hidden no-print">
            <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Sesiones Guardadas</h2>
                    <button id="new-session-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Nueva</button>
                </div>
                <div id="session-list" class="overflow-y-auto flex-grow p-2">
                    <div id="loading-sessions" class="p-4 text-center text-slate-500">Cargando sesiones...</div>
                </div>
            </aside>
            <section class="w-full md:w-2/3 lg:w-3/4 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
                <div id="form-header" class="p-4 border-b flex justify-between items-center flex-wrap gap-2">
                    <h2 id="form-title" class="text-lg font-semibold">Selecciona una sesión o crea una nueva</h2>
                    <div id="action-buttons" class="flex gap-2 hidden">
                        <button id="save-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button>
                        <button id="duplicate-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Duplicar</button>
                        <button id="print-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Imprimir</button>
                        <button id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Eliminar</button>
                    </div>
                </div>
                <div id="form-container" class="overflow-y-auto flex-grow p-4">
                    <form id="session-form"></form>
                    <div id="welcome-message" class="text-center text-slate-500 p-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <p class="mt-4 text-lg">Haz clic en "Nueva" para empezar a planificar tu primera sesión.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <div id="print-area"></div>
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3 mx-auto flex flex-col items-center text-center">
            <div id="modal-spinner" class="spinner hidden mb-4"></div>
            <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
            <p id="modal-text" class="py-4 text-slate-600"></p>
            <div id="modal-buttons" class="text-right space-x-2"></div>
        </div>
    </div>
    <div id="dua-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto">
            <h3 id="dua-modal-title" class="text-xl font-bold text-slate-800"></h3>
            <div id="dua-modal-content" class="py-4 space-y-2 max-h-96 overflow-y-auto"></div>
            <div id="dua-modal-buttons" class="text-right space-x-2">
                <button id="dua-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                <button id="dua-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar Pautas</button>
            </div>
        </div>
    </div>

    <script type="module">
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyIClBck1KBGo7S4K3Hop1rkmSBNXjfP6MZ8Rsu714E_PIlNiZuimJfkH_j95HGKmSIZQ/exec";

        const evaluationData = [
            { id: "1.1", text: "1.1 Construir y expresar un concepto ajustado de sí mismo...", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
            { id: "1.2", text: "1.2 Identificar, gestionar y comunicar ideas...", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
            { id: "1.3", text: "1.3 Desarrollar y demostrar autonomía moral...", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
            { id: "2.1", text: "2.1 Promover y demostrar una convivencia pacífica...", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "2.2", text: "2.2 Fomentar el ejercicio de la ciudadanía activa...", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "2.3", text: "2.3 Promover estilos de vida éticamente comprometidos...", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },
            { id: "4.1", text: "4.1 Desarrollar una actitud de gestión equilibrada de las emociones...", cesp: "CESP4", descriptores: ["CCL1", "CPSAA1", "CPSAA2", "CPSAA3", "CC1", "CC3", "CCEC3"], claves: ["CCL", "CPSAA", "CC", "CCEC"] }
        ];
        const duaData = {
            'principle1': { title: "I. Proporcionar múltiples medios de representación", guidelines: [ { id: '1.1', text: 'Pauta 1.1: Ofrecer opciones para la percepción' }, { id: '1.2', text: 'Pauta 1.2: Ofrecer opciones para el lenguaje y los símbolos' }, { id: '1.3', text: 'Pauta 1.3: Ofrecer opciones para la comprensión' } ] },
            'principle2': { title: "II. Proporcionar múltiples medios de acción y expresión", guidelines: [ { id: '2.1', text: 'Pauta 4: Ofrecer opciones para la acción física' }, { id: '2.2', text: 'Pauta 5: Ofrecer opciones para la expresión y la comunicación' }, { id: '2.3', text: 'Pauta 6: Ofrecer opciones para las funciones ejecutivas' } ] },
            'principle3': { title: "III. Proporcionar múltiples formas de implicación", guidelines: [ { id: '3.1', text: 'Pauta 7: Ofrecer opciones para captar el interés' }, { id: '3.2', text: 'Pauta 8: Ofrecer opciones para mantener el esfuerzo y la persistencia' }, { id: '3.3', text: 'Pauta 9: Ofrecer opciones para la autorregulación' } ] }
        };
        const appData = {
            materias: ["Filosofía", "Hª de la Filosofía", "Valores Éticos", "Psicología"],
            cursos: ["1º ESO", "2º ESO", "3º ESO", "4º ESO", "1º Bachillerato", "2º Bachillerato"],
            sesiones: Array.from({length: 25}, (_, i) => `Sesión ${i + 1}`),
            metodologias: ["Aprendizaje Basado en Proyectos (ABP)", "Flipped Classroom", "Gamificación", "Aprendizaje Cooperativo", "Clase Magistral Interactiva", "Debate Dirigido"],
            tiposEvaluacion: ["Diagnóstica", "Formativa", "Sumativa", "Autoevaluación", "Coevaluación"],
            criteriosCalificacion: ["Examen escrito (40%)", "Trabajo de investigación (30%)", "Participación en clase (10%)", "Portfolio (20%)"],
            adaptaciones: ["Adaptación curricular no significativa", "Adaptación curricular significativa", "Actividades de ampliación", "Actividades de refuerzo"],
            contenidosTransversales: ["Educación para la paz", "Educación para la igualdad de género", "Educación ambiental", "Educación para la salud"]
        };

        let currentSessionId = null;
        let currentDuaPrincipleKey = null;
        let allSessions = [];

        function showModal(title, text, options = {}) {
            const { showSpinner = false, buttons = [{text: 'OK', class: 'bg-blue-500', callback: hideModal}] } = options;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            document.getElementById('modal-spinner').style.display = showSpinner ? 'block' : 'none';
            const buttonsContainer = document.getElementById('modal-buttons');
            buttonsContainer.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `text-white font-bold py-2 px-4 rounded-lg transition-colors ${btnInfo.class}`;
                button.addEventListener('click', () => { hideModal(); if(btnInfo.callback) btnInfo.callback(); });
                buttonsContainer.appendChild(button);
            });
            document.getElementById('modal').classList.remove('hidden');
        }
        function hideModal() { document.getElementById('modal').classList.add('hidden'); }
        function showDuaModal(principleKey) {
            currentDuaPrincipleKey = principleKey;
            const principle = duaData[principleKey];
            document.getElementById('dua-modal-title').textContent = principle.title;
            const content = document.getElementById('dua-modal-content');
            content.innerHTML = '';
            const savedSelections = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
            principle.guidelines.forEach(guideline => {
                const cbWrapper = document.createElement('div');
                cbWrapper.className = 'flex items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `dua-guideline-${guideline.id}`;
                checkbox.value = guideline.text;
                checkbox.checked = savedSelections.includes(guideline.text);
                checkbox.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = guideline.text;
                label.className = 'ml-3 text-sm text-slate-600';
                cbWrapper.appendChild(checkbox);
                cbWrapper.appendChild(label);
                content.appendChild(cbWrapper);
            });
            document.getElementById('dua-modal').classList.remove('hidden');
        }
        function hideDuaModal() { currentDuaPrincipleKey = null; document.getElementById('dua-modal').classList.add('hidden'); }
        function saveDuaGuidelines() {
            const newlySelected = Array.from(document.querySelectorAll('#dua-modal-content input[type="checkbox"]:checked')).map(cb => cb.value);
            const previouslySaved = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
            const guidelinesForCurrentPrinciple = duaData[currentDuaPrincipleKey].guidelines.map(g => g.text);
            const otherGuidelines = previouslySaved.filter(g => !guidelinesForCurrentPrinciple.includes(g));
            document.getElementById('selectedDuaGuidelines').value = JSON.stringify([...otherGuidelines, ...newlySelected]);
            hideDuaModal();
        }

        function createFormField(id, label, type, options = []) {
            const wrapper = document.createElement('div');
            const labelEl = document.createElement('label');
            labelEl.setAttribute('for', id);
            labelEl.className = "block text-sm font-medium text-slate-700 mb-1";
            labelEl.textContent = label;
            wrapper.appendChild(labelEl);

            let field;
            if (type === 'textarea') {
                field = document.createElement('textarea');
                field.rows = 3;
                field.className = "w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500";
            } else if (type === 'readonly-textarea') {
                field = document.createElement('textarea');
                field.rows = 3;
                field.readOnly = true;
                field.className = "w-full p-2 border border-slate-300 rounded-md s
