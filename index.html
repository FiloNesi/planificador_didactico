<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificador Didáctico de Filosofía</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    select[multiple] { padding: 0.5rem; }
    .checkbox-group { max-height: 20rem; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Estilos para la impresión */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
      .no-print { display: none; }
    }
    /* Clases de Prosa para Tailwind, para el contenido del informe */
    .prose { color: #334155; max-width: 65ch; }
    .prose a { color: #4f46e5; text-decoration: underline; }
    .prose strong { color: #1e293b; font-weight: 600; }
    .prose blockquote { border-left-color: #e2e8f0; }
    .prose thead { border-bottom-color: #e2e8f0; }
    .prose-sm { font-size: 0.875rem; line-height: 1.5; }
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div id="app-container" class="flex flex-col h-screen">
    <header class="bg-white shadow-md p-3 flex justify-between items-center no-print flex-shrink-0">
      <h1 class="text-xl font-bold text-slate-700">Planificador Didáctico</h1>
    </header>
    <main class="flex-grow flex flex-col md:flex-row gap-3 p-3 overflow-hidden no-print">
      <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-4 border-b flex justify-between items-center gap-2">
          <h2 class="text-lg font-semibold">Sesiones</h2>
          <div class="flex gap-2">
            <button id="search-session-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold p-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
            </button>
            <button id="new-session-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Nueva</button>
          </div>
        </div>
        <div id="session-list" class="overflow-y-auto flex-grow p-2">
          <!-- El contenido se genera dinámicamente -->
        </div>
      </aside>
      <section class="w-full md:w-2/3 lg:w-3/4 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
        <div id="form-header" class="p-3 border-b flex justify-between items-center flex-wrap gap-2">
          <h2 id="form-title" class="text-lg font-semibold">Selecciona una sesión o crea una nueva</h2>
          <div class="flex items-center gap-2">
            <span id="autosave-status" class="text-sm text-slate-500 transition-opacity duration-300 opacity-0"></span>
            <div id="action-buttons" class="flex gap-2 hidden">
              <button id="save-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button>
              <button id="duplicate-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Duplicar</button>
              <button id="print-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Imprimir</button>
              <button id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Eliminar</button>
            </div>
          </div>
        </div>
        <div id="form-container" class="overflow-y-auto flex-grow p-4">
          <form id="session-form" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-4"></form>
          <div id="welcome-message" class="text-center text-slate-500 p-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <p class="mt-4 text-lg">Haz clic en "Nueva" para empezar a planificar tu primera sesión.</p>
          </div>
        </div>
      </section>
    </main>
  </div>
  <div id="print-area"></div>

  <!-- Modal genérico -->
  <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3 mx-auto flex flex-col items-center text-center">
      <div id="modal-spinner" class="spinner hidden mb-4"></div>
      <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
      <p id="modal-text" class="py-4 text-slate-600"></p>
      <div id="modal-buttons" class="text-right space-x-2"></div>
    </div>
  </div>

  <!-- Modal DUA -->
  <div id="dua-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto">
      <h3 id="dua-modal-title" class="text-xl font-bold text-slate-800"></h3>
      <div id="dua-modal-content" class="py-4 space-y-2 max-h-96 overflow-y-auto"></div>
      <div id="dua-modal-buttons" class="text-right space-x-2">
        <button id="dua-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
        <button id="dua-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar Pautas</button>
      </div>
    </div>
  </div>
  
  <!-- Modal Unidad Didáctica -->
  <div id="ud-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto">
      <h3 class="text-xl font-bold text-slate-800 mb-4">Seleccionar Unidad Didáctica</h3>
      <div id="ud-modal-content" class="grid grid-cols-3 sm:grid-cols-5 gap-4 py-4">
        <!-- Numbers will be populated here -->
      </div>
      <div class="text-right">
        <button id="ud-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Selector Múltiple -->
  <div id="multi-select-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto">
      <h3 id="multi-select-modal-title" class="text-xl font-bold text-slate-800 mb-4"></h3>
      <div id="multi-select-modal-content" class="grid grid-cols-1 md:grid-cols-2 gap-4 py-4 max-h-96 overflow-y-auto"></div>
      <div class="text-right space-x-2">
        <button id="multi-select-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
        <button id="multi-select-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Búsqueda -->
  <div id="search-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 mx-auto">
        <h3 class="text-xl font-bold text-slate-800 mb-4">Buscar Sesiones</h3>
        <form id="search-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="search-materia" class="block text-sm font-medium text-slate-700 mb-1">Materia</label>
                    <select id="search-materia" name="materia" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div>
                    <label for="search-curso" class="block text-sm font-medium text-slate-700 mb-1">Curso</label>
                    <select id="search-curso" name="curso" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                 <div>
                    <label for="search-sesion" class="block text-sm font-medium text-slate-700 mb-1">Sesión</label>
                    <select id="search-sesion" name="sesionNum" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div>
                    <label for="search-titulo" class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                    <input type="text" id="search-titulo" name="situacionAprendizaje" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Contiene el texto...">
                </div>
                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="search-fecha-desde" class="block text-sm font-medium text-slate-700 mb-1">Fecha Desde</label>
                        <input type="date" id="search-fecha-desde" name="fechaDesde" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="search-fecha-hasta" class="block text-sm font-medium text-slate-700 mb-1">Fecha Hasta</label>
                        <input type="date" id="search-fecha-hasta" name="fechaHasta" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button id="search-clear-btn" type="button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Limpiar</button>
                <button id="search-cancel-btn" type="button" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                <button id="search-submit-btn" type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Buscar</button>
            </div>
        </form>
    </div>
  </div>

  <!-- Plantillas HTML -->
  <template id="template-session-item">
    <div class="p-3 m-1 rounded-lg cursor-pointer border-l-4 transition-colors hover:bg-slate-100 border-transparent">
      <h3 class="font-semibold truncate" data-template="title"></h3>
      <p class="text-sm text-slate-500" data-template="subtitle"></p>
    </div>
  </template>

  <template id="template-print-card">
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 print:shadow-none print:border print:border-slate-200">
        <div class="p-6">
            <div class="flex items-center">
                <div data-template="icon-container"></div>
                <h3 class="text-xl font-bold text-slate-800" data-template="title"></h3>
            </div>
            <div class="mt-4 text-slate-600 pl-9" data-template="content"></div>
        </div>
    </div>
  </template>

  <template id="template-print-sidebar-card">
    <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 print:shadow-none print:border print:border-slate-200">
        <div class="p-5">
            <div class="flex items-center border-b border-slate-200 pb-3 mb-3">
                <div data-template="icon-container"></div>
                <h4 class="text-md font-bold text-slate-700" data-template="title"></h4>
            </div>
            <div class="text-sm text-slate-600" data-template="content"></div>
        </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>

  <script type="module">
    // =============================
    // MODULE: CONFIG
    // =============================
    const config = {
        SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyIClBck1KBGo7S4K3Hop1rkmSBNXjfP6MZ8Rsu714E_PIlNiZuimJfkH_j95HGKmSIZQ/exec",
        evaluationData: [
            { id: "1.1", text: "1.1 Autoconcepto personal y moral a través del diálogo sobre la naturaleza humana.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
            { id: "1.2", text: "1.2 Expresión y gestión empática de emociones, ideas y relaciones.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
            { id: "1.3", text: "1.3 Autonomía moral mediante la deliberación ética y el diálogo respetuoso.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
            { id: "2.1", text: "2.1 Convivencia democrática y crítica a partir de conceptos sociales y políticos.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "2.2", text: "2.2 Ciudadanía activa mediante la participación asociativa y decisiones colectivas.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "2.3", text: "2.3 Compromiso ético frente a desigualdad, pobreza y límites de la ciencia.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "2.4", text: "2.4 Igualdad de género y respeto a derechos LGTBIQ+ frente a discriminación.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "2.5", text: "2.5 Defensa de los derechos humanos y respeto por la diversidad y los bienes comunes.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "2.6", text: "2.6 Compromiso con la paz, la democracia y la solidaridad internacional.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
            { id: "3.1", text: "3.1 Interdependencia entre vida humana y entorno ante los problemas ecosociales.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },
            { id: "3.2", text: "3.2 Debate crítico sobre respuestas científicas, políticas y éticas a la crisis climática.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },
            { id: "3.3", text: "3.3 Estilos de vida sostenibles y responsables con personas, animales y medio ambiente.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },
            { id: "4.1", text: "4.1 Gestión equilibrada de emociones y cuidado mutuo en contextos éticos y creativos.", cesp: "CESP4", descriptores: ["CCL1", "CPSAA1", "CPSAA2", "CPSAA3", "CC1", "CC3", "CCEC3"], claves: ["CCL", "CPSAA", "CC", "CCEC"] }
        ],
        duaData: {
            principle1: { title: "I. Proporcionar múltiples medios de representación", guidelines: [
                { id: 'p1-7.1', text: '7.1 Ofrecer opciones para atraer la atención.' },
                { id: 'p1-7.2', text: '7.2 Optimizar la relevancia, el valor y la autenticidad.' },
                { id: 'p1-7.3', text: '7.3 Minimizar la amenaza y la distracción.' },
                { id: 'p1-8.1', text: '8.1 Proporcionar metas de aprendizaje claras y con andamiaje.' },
                { id: 'p1-8.2', text: '8.2 Utilizar la colaboración y la comunidad como apoyo.' },
                { id: 'p1-8.3', text: '8.3 Aumentar el feedback orientado al dominio y la perseverancia.' },
                { id: 'p1-9.1', text: '9.1 Promover expectativas y creencias que optimicen la motivación.' },
                { id: 'p1-9.2', text: '9.2 Facilitar estrategias para afrontar retos y gestionar emociones.' },
                { id: 'p1-9.3', text: '9.3 Desarrollar la autoevaluación y la reflexión personal.' }
            ]},
            principle2: { title: "II. Proporcionar múltiples medios de acción y expresión", guidelines: [
                { id: 'p2-1.1', text: '1.1 Ofrecer modos alternativos de presentar la información.' },
                { id: 'p2-1.2', text: '1.2 Ofrecer alternativas para la información auditiva.' },
                { id: 'p2-1.3', text: '1.3 Ofrecer alternativas para la información visual.' },
                { id: 'p2-2.1', text: '2.1 Aclarar vocabulario y símbolos.' },
                { id: 'p2-2.2', text: '2.2 Aclarar la sintaxis y la estructura.' },
                { id: 'p2-2.3', text: '2.3 Apoyar la decodificación de textos, notación matemática y símbolos.' },
                { id: 'p2-2.4', text: '2.4 Promover la comprensión de los diferentes idiomas.' },
                { id: 'p2-2.5', text: '2.5 Ilustrar a través de múltiples medios.' },
                { id: 'p2-3.1', text: '3.1 Activar o aportar conocimientos previos.' },
                { id: 'p2-3.2', text: '3.2 Destacar patrones, características y relaciones clave.' },
                { id: 'p2-3.3', text: '3.3 Guiar el procesamiento de la información y la visualización.' },
                { id: 'p2-3.4', text: '3.4 Maximizar la transferencia y la generalización.' }
            ]},
            principle3: { title: "III. Proporcionar múltiples formas de implicación", guidelines: [
                { id: 'p3-4.1', text: '4.1 Variedad de métodos de respuesta y navegación.' },
                { id: 'p3-4.2', text: '4.2 Acceso optimizado a herramientas y tecnologías.' },
                { id: 'p3-5.1', text: '5.1 Múltiples medios para la comunicación.' },
                { id: 'p3-5.2', text: '5.2 Múltiples herramientas para la construcción y composición.' },
                { id: 'p3-5.3', text: '5.3 Apoyos para la fluidez con diferentes medios de comunicación.' },
                { id: 'p3-6.1', text: '6.1 Guiar la definición de metas adecuadas.' },
                { id: 'p3-6.2', text: '6.2 Apoyar la planificación y el desarrollo de estrategias.' },
                { id: 'p3-6.3', text: '6.3 Facilitar la gestión de la información y de recursos.' },
                { id: 'p3-6.4', text: '6.4 Promover la monitorización del progreso.' }
            ]}
        },
        appData: {
            materias: ["Filosofía","Hª de la Filosofía","Valores Éticos","Psicología"],
            cursos: ["1º ESO","2º ESO","3º ESO","4º ESO","1º Bachillerato","2º Bachillerato"],
            sesiones: Array.from({length:15},(_,i)=>`Sesión ${i+1}`),
            tiposEvaluacion: ["Formativa", "Competencial", "Sumativa", "Heteroevaluación", "Autoevaluación", "Coevaluación"],
            contenidosTransversales: ["Educación para la paz","Educación para la igualdad de género","Educación ambiental","Educación para la salud"],
            contenidos: [
                "– La investigación ética y la resolución de problemas complejos. El pensamiento crítico y filosófico.",
                "– La naturaleza humana y la identidad personal. Dignidad, libertad y moralidad.",
                "– La educación de las emociones y los sentimientos. La autoestima personal. La igualdad y el respeto mutuo en las relaciones con otras personas.",
                "– La educación afectivo-sexual.",
                "– Deseos y razones. La voluntad y el juicio moral. Autonomía y responsabilidad.",
                "– La ética como guía de nuestras acciones. La reflexión en torno a lo valioso y los valores: universalismo y pluralismo moral. Normas, virtudes y sentimientos morales. Éticas de la felicidad, éticas del deber y éticas de la virtud.",
                "– El conflicto entre legitimidad y legalidad. La objeción de conciencia. Los derechos individuales y el debate en torno a la libertad de expresión.",
                "– El problema de la desinformación. La protección de datos y el derecho a la intimidad. El ciberacoso y las situaciones de violencia en las redes. Las conductas adictivas.",
                "– Las virtudes del diálogo y las normas de argumentación. La resolución pacífica de conflictos. La empatía con los demás.",
                "– La naturaleza y origen de la sociedad: competencia y cooperación, egoísmo y altruismo. Las estructuras sociales y los grupos de pertenencia.",
                "– La política: ley, poder, soberanía y justicia. Formas de Estado y tipos de gobierno. El Estado de derecho y los valores constitucionales. La democracia: principios, procedimientos e instituciones. La memoria democrática. La guerra, el terrorismo y otras formas de violencia política.",
                "– Las distintas generaciones de derechos humanos. Su constitución histórica y relevancia ética. Los derechos de la infancia.",
                "– Asociacionismo y voluntariado. La ciudadanía y la participación democrática. Los códigos deontológicos. Las éticas aplicadas.",
                "– La desigualdad económica y la lucha contra la pobreza. Globalización económica y bienes públicos globales. El comercio justo. El derecho al trabajo, la salud, la educación y la justicia. El valor social de los impuestos.",
                "– La igualdad de género y las diversas olas y corrientes del feminismo. La prevención de la explotación y la violencia contra niñas y mujeres. La corresponsabilidad en las tareas domésticas y de cuidados.",
                "– El interculturalismo. La inclusión social y el respeto por la diversidad y las identidades etnocultural y de género. Los derechos LGTBIQ+.",
                "– Fines y límites éticos de la investigación científica. La bioética. El desafío de la inteligencia artificial. Las propuestas transhumanistas.",
                "– Acciones individuales y colectivas en favor de la paz. La contribución del Estado y los organismos internacionales a la paz, la seguridad integral y la cooperación. La atención a las víctimas de la violencia. El derecho internacional y la ciudadanía global. Las fuerzas armadas y la defensa al servicio de la paz. El papel de las ONG y de las ONGD.",
                "– Interdependencia, interconexión y ecodependencia entre nuestras formas de vida y el entorno. Lo local y lo global. Consideración crítica de las diversas cosmovisiones sobre la relación humana con la naturaleza.",
                "– Los límites del planeta y el agotamiento de los recursos. La huella ecológica de las acciones humanas. La emergencia climática.",
                "– Diversos planteamientos éticos, científicos y políticos en torno a los problemas ecosociales. La ética ambiental. La ética de los cuidados y el ecofeminismo. Los Objetivos de Desarrollo Sostenible. El decrecimiento. La economía circular.",
                "– El compromiso activo con la protección de los animales y el medio ambiente. Los derechos de los animales y de la naturaleza. La perspectiva biocéntrica.",
                "– Estilos de vida sostenible: la prevención de los residuos y la gestión sostenible de los recursos. La movilidad segura, saludable y sostenible. El consumo responsable. Alimentación y soberanía alimentaria. Comunidades resilientes y en transición."
            ]
        },
        allEditorIds: ['situacionAprendizaje', 'contextoReto', 'metodologias', 'resultadosEsperados', 'preparacionPrevia', 'actividad1', 'actividad2', 'actividad3', 'actividad4', 'instrumentosEvaluacion', 'recursos', 'observaciones', 'adaptacion', 'criteriosCalificacion']
    };

    // =============================
    // MODULE: STATE
    // =============================
    const state = {
        currentSessionId: null,
        currentDuaPrincipleKey: null,
        allSessions: [],
        autoSaveTimer: null,
        editors: {},
        currentMultiSelect: null
    };

    // =============================
    // MODULE: API
    // =============================
    const api = {
        async call(action, data = {}) {
            const res = await fetch(config.SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
                body: JSON.stringify({ action, ...data })
            });
            if (!res.ok) throw new Error(`Error de red: ${res.status} ${res.statusText}`);
            const text = await res.text();
            let result;
            try {
                result = JSON.parse(text);
            } catch {
                throw new Error(`Respuesta no JSON del servidor: ${text.slice(0, 200)}`);
            }
            if (!result.success) throw new Error(result.message || 'Error desconocido en el servidor');
            return result.data;
        }
    };

    // =============================
    // MODULE: UI
    // =============================
    const ui = {
        showModal(title, text, options = {}) {
            const { showSpinner = false, buttons = [{ text: 'OK', class: 'bg-blue-500', callback: ui.hideModal }] } = options;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            document.getElementById('modal-spinner').style.display = showSpinner ? 'block' : 'none';
            const buttonsContainer = document.getElementById('modal-buttons');
            buttonsContainer.innerHTML = '';
            buttons.forEach(info => {
                const b = document.createElement('button');
                b.textContent = info.text;
                b.className = `text-white font-bold py-2 px-4 rounded-lg transition-colors ${info.class}`;
                b.addEventListener('click', () => { ui.hideModal(); if (info.callback) info.callback(); });
                buttonsContainer.appendChild(b);
            });
            document.getElementById('modal').classList.remove('hidden');
        },

        hideModal() {
            document.getElementById('modal').classList.add('hidden');
        },

        showDuaModal(principleKey) {
            state.currentDuaPrincipleKey = principleKey;
            const principle = config.duaData[principleKey];
            document.getElementById('dua-modal-title').textContent = principle.title;
            const content = document.getElementById('dua-modal-content');
            content.innerHTML = '';
            const saved = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
            principle.guidelines.forEach(g => {
                const row = document.createElement('div'); row.className = 'flex items-center';
                const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `dua-guideline-${g.id}`; cb.value = g.text; cb.checked = saved.includes(g.text); cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
                const label = document.createElement('label'); label.htmlFor = cb.id; label.textContent = g.text; label.className = 'ml-3 text-sm text-slate-600';
                row.appendChild(cb); row.appendChild(label); content.appendChild(row);
            });
            document.getElementById('dua-modal').classList.remove('hidden');
        },

        hideDuaModal() {
            state.currentDuaPrincipleKey = null;
            document.getElementById('dua-modal').classList.add('hidden');
        },

        showUdModal() {
            const content = document.getElementById('ud-modal-content');
            content.innerHTML = '';
            const currentValue = document.getElementById('unidadDidactica').value;

            for (let i = 1; i <= 15; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.dataset.value = i;
                button.className = `p-4 rounded-lg text-center font-bold transition-colors ${i == currentValue ? 'bg-blue-500 text-white' : 'bg-slate-100 hover:bg-slate-200'}`;
                button.addEventListener('click', () => {
                    document.getElementById('unidadDidactica').value = i;
                    document.getElementById('ud-display').textContent = `Unidad ${i}`;
                    app.triggerAutoSave();
                    ui.hideUdModal();
                });
                content.appendChild(button);
            }
            document.getElementById('ud-modal').classList.remove('hidden');
        },

        hideUdModal() {
            document.getElementById('ud-modal').classList.add('hidden');
        },
        
        showMultiSelectModal(type) {
            state.currentMultiSelect = type;
            const modal = document.getElementById('multi-select-modal');
            const titleEl = document.getElementById('multi-select-modal-title');
            const contentEl = document.getElementById('multi-select-modal-content');
            contentEl.innerHTML = '';

            let title = '';
            let options = [];
            
            if (type === 'materia') {
                title = 'Seleccionar Materia(s)';
                options = config.appData.materias;
            } else if (type === 'curso') {
                title = 'Seleccionar Curso(s)';
                options = config.appData.cursos;
            } else if (type === 'sesionNum') {
                title = 'Seleccionar Sesión(es)';
                options = config.appData.sesiones;
            } else if (type === 'contenidos') {
                title = 'Seleccionar Contenidos';
                options = config.appData.contenidos;
            } else if (type === 'tiposEvaluacion') {
                title = 'Seleccionar Tipos de Evaluación';
                options = config.appData.tiposEvaluacion;
            }

            titleEl.textContent = title;
            const currentValues = JSON.parse(document.getElementById(type).value || '[]');

            options.forEach(opt => {
                const wrapper = document.createElement('div');
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.id = `ms-${type}-${opt.substring(0, 20)}`; // Use a substring for unique ID
                cb.value = opt;
                cb.checked = currentValues.includes(opt);
                cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
                const label = document.createElement('label');
                label.htmlFor = cb.id;
                label.textContent = opt;
                label.className = 'ml-2 text-sm text-slate-600';
                wrapper.appendChild(cb);
                wrapper.appendChild(label);
                contentEl.appendChild(wrapper);
            });

            modal.classList.remove('hidden');
        },

        hideMultiSelectModal() {
            state.currentMultiSelect = null;
            document.getElementById('multi-select-modal').classList.add('hidden');
        },
        
        updateChipsDisplay(fieldId, values) {
            const displayEl = document.getElementById(`${fieldId}-display`);
            if (!displayEl) return;
            
            displayEl.innerHTML = '';
            if (values && values.length > 0) {
                values.forEach(value => {
                    const chip = document.createElement('span');
                    chip.className = 'inline-block text-xs bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5 mr-1 mb-1';
                    chip.textContent = value;
                    displayEl.appendChild(chip);
                });
            } else {
                displayEl.innerHTML = '<span class="text-slate-400">No seleccionado</span>';
            }
        },

        showSearchModal() {
            const populateSelect = (selectId, data) => {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                data.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt;
                    o.textContent = opt;
                    select.appendChild(o);
                });
            };
            populateSelect('search-materia', config.appData.materias);
            populateSelect('search-curso', config.appData.cursos);
            populateSelect('search-sesion', config.appData.sesiones);
            document.getElementById('search-modal').classList.remove('hidden');
        },

        hideSearchModal() {
            document.getElementById('search-modal').classList.add('hidden');
        },

        createFormField(id, label, type, options = []) {
            const wrapper = document.createElement('div');
            const labelEl = document.createElement('label');
            labelEl.setAttribute('for', id);
            labelEl.className = 'block text-sm font-medium text-slate-700 mb-1';
            labelEl.textContent = label;
            wrapper.appendChild(labelEl);

            let field;
            if (type === 'textarea') {
                field = document.createElement('textarea');
                field.className = 'hidden';
                wrapper.appendChild(field);
            } else if (type === 'date') {
                field = document.createElement('input');
                field.type = 'date';
                field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500';
                wrapper.appendChild(field);
            } else if (type === 'readonly-textarea') {
                field = document.createElement('textarea'); field.rows = 3; field.readOnly = true;
                field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm bg-slate-100 focus:ring-0 focus:border-slate-300 cursor-not-allowed';
                wrapper.appendChild(field);
            } else if (type === 'checkbox-group') {
                field = document.createElement('div'); field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm overflow-y-auto checkbox-group';
                options.forEach(opt => {
                    const row = document.createElement('div'); row.className = 'flex items-start my-2';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `${id}-${opt.id}`; cb.name = id; cb.value = opt.text; cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-1 flex-shrink-0';
                    const lab = document.createElement('label'); lab.htmlFor = cb.id; lab.textContent = opt.text; lab.className = 'ml-3 text-sm text-slate-600';
                    row.appendChild(cb); row.appendChild(lab); field.appendChild(row);
                });
                wrapper.appendChild(field);
            } else if (type === 'dua-group') {
                field = document.createElement('div'); field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm space-y-3';
                const hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.id = 'selectedDuaGuidelines'; field.appendChild(hidden);
                Object.entries(config.duaData).forEach(([key, value]) => {
                    const item = document.createElement('div'); item.className = 'flex items-center justify-between';
                    const left = document.createElement('div'); left.className = 'flex items-center';
                    const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `dua-${key}`; cb.name = 'dua'; cb.value = value.title; cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
                    const lab = document.createElement('label'); lab.htmlFor = cb.id; lab.textContent = value.title; lab.className = 'ml-3 text-sm text-slate-600';
                    left.appendChild(cb); left.appendChild(lab); item.appendChild(left);
                    if (value.guidelines.length) {
                        const btn = document.createElement('button'); btn.type = 'button'; btn.textContent = 'Seleccionar Pautas'; btn.className = 'text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-lg transition-colors';
                        btn.addEventListener('click', () => ui.showDuaModal(key)); item.appendChild(btn);
                    }
                    field.appendChild(item);
                });
                wrapper.appendChild(field);
            }

            if (field) {
                field.id = id;
                if (type !== 'checkbox-group' && type !== 'dua-group') {
                    field.name = id;
                }
            }

            return wrapper;
        },

        ensureEditorsInitialized(ids) {
            ids.forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea && !state.editors[id]) {
                    state.editors[id] = SUNEDITOR.create(id, {
                        buttonList: [['undo', 'redo'], ['bold', 'italic', 'underline'], ['list']],
                        height: 'auto',
                        minHeight: '100px',
                        callbacks: { onChange: app.triggerAutoSave }
                    });
                }
            });
        },

        destroyEditors() {
            Object.values(state.editors).forEach(editor => {
                if (editor && typeof editor.destroy === 'function') {
                    editor.destroy();
                }
            });
            state.editors = {};
        },

        updateDerivedFields() {
            const selected = Array.from(document.querySelectorAll('input[name="criteriosEvaluacion"]:checked')).map(cb => cb.value);
            const allCesp = new Set(), allDes = new Set(), allClaves = new Set();
            config.evaluationData.forEach(c => { if (selected.includes(c.text)) { allCesp.add(c.cesp); c.descriptores.forEach(d => allDes.add(d)); c.claves.forEach(k => allClaves.add(k)); } });
            document.getElementById('competenciaEspecifica').value = [...allCesp].join(', ');
            document.getElementById('descriptoresOperativos').value = [...allDes].join(', ');
            document.getElementById('competenciasClave').value = [...allClaves].join(', ');
        },

        renderInfoSummary() {
            const data = app.getFormData();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.situacionAprendizaje || '';
            const title = tempDiv.textContent.split('\n')[0] || 'Sesión sin título';
            const materia = data.materia || [];
            const curso = data.curso || [];
            const sesionNum = data.sesionNum || [];
            const fecha = data.fecha;
            const formattedDate = fecha ? new Date(fecha).toLocaleDateString('es-ES', { timeZone: 'UTC' }) : '<span class="text-slate-400">Sin fecha</span>';

            const summary = document.getElementById('info-summary') || (() => { const d = document.createElement('div'); d.id = 'info-summary'; d.className = 'hidden mb-4'; document.getElementById('form-step-2')?.prepend(d); return d; })();
            summary.innerHTML = `
                <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Información general</h3>
                        <button id="edit-info-btn" type="button" class="text-xs font-semibold text-blue-600 hover:underline">Editar</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                        <div class="lg:col-span-2"><div class="text-xs uppercase text-slate-500">Título</div><div class="text-sm text-slate-800">${title || '<span class="text-slate-400">Sin título</span>'}</div></div>
                        <div><div class="text-xs uppercase text-slate-500">Materia(s)</div><div>${ui.chipsHtml(materia)}</div></div>
                        <div><div class="text-xs uppercase text-slate-500">Curso(s)</div><div>${ui.chipsHtml(curso)}</div></div>
                        <div><div class="text-xs uppercase text-slate-500">Sesión(es)</div><div>${ui.chipsHtml(sesionNum)}</div></div>
                        <div><div class="text-xs uppercase text-slate-500">Fecha</div><div class="text-sm text-slate-800">${formattedDate}</div></div>
                    </div>
                </div>`;
            summary.classList.remove('hidden');
            document.getElementById('edit-info-btn')?.addEventListener('click', () => {
                document.getElementById('form-step-1').classList.remove('hidden');
                document.getElementById('form-step-2').classList.add('hidden');
                document.getElementById('form-step-3').classList.add('hidden');
                document.getElementById('continue-btn-1').classList.remove('hidden');
                document.getElementById('action-buttons').classList.add('hidden');
                document.getElementById('info-summary').classList.add('hidden');
                document.getElementById('form-title').textContent = 'Paso 1: Información General';
            }, { once: true });
        },

        chipsHtml(arr) {
            const a = Array.isArray(arr) ? arr : [];
            return a.length ? a.map(v => `<span class="inline-block text-xs bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5 mr-1 mb-1">${String(v)}</span>`).join('') : '<span class="text-slate-400 text-sm">Sin seleccionar</span>';
        },

        buildForm() {
            ui.destroyEditors();
            const form = document.getElementById('session-form');
            form.innerHTML = '';
            const step1 = document.createElement('div'); step1.id = 'form-step-1'; step1.className = 'space-y-6';
            const step2 = document.createElement('div'); step2.id = 'form-step-2'; step2.className = 'hidden space-y-6';
            const step3 = document.createElement('div'); step3.id = 'form-step-3'; step3.className = 'hidden space-y-6';
            const step4 = document.createElement('div'); step4.id = 'form-step-4'; step4.className = 'hidden space-y-6';
            const step5 = document.createElement('div'); step5.id = 'form-step-5'; step5.className = 'hidden space-y-6';
            
            const fieldsets = [
                { step:1, legend: 'Información General', fields:[
                    { id:'situacionAprendizaje', label:'Sesión de Aprendizaje', type:'textarea' }, { id:'unidadDidactica', label:'Unidad Didáctica', type:'ud-selector' }, { id:'fecha', label:'Fecha', type:'date' }, { id:'materia', label:'Materia', type:'modal-multiselect' }, { id:'curso', label:'Curso', type:'modal-multiselect' }, { id:'sesionNum', label:'Nº de la Sesión', type:'modal-multiselect' },
                ]},
                { step:2, legend: 'Detalles de la Sesión', fields:[
                    { id:'contextoReto', label:'Contexto-reto', type:'textarea' }, { id:'contenidos', label:'Contenidos', type:'modal-multiselect' }, { id:'metodologias', label:'Metodologías', type:'textarea' }, { id:'resultadosEsperados', label:'Resultados esperados al final de la sesión', type:'textarea' }, { id:'preparacionPrevia', label:'Preparación previa', type:'textarea' },
                ]},
                { step:3, legend: 'Actividades', fields:[
                    { id:'actividad1', label:'Actividad 1', type:'textarea' }, { id:'actividad2', label:'Actividad 2', type:'textarea' }, { id:'actividad3', label:'Actividad 3', type:'textarea' }, { id:'actividad4', label:'Actividad 4', type:'textarea' },
                ]},
                { step:4, legend: 'Evaluación', fields:[
                    { id:'criteriosEvaluacion', label:'Criterios de Evaluación', type:'checkbox-group', options: config.evaluationData }, { id:'instrumentosEvaluacion', label:'Instrumentos de Evaluación', type:'textarea' }, { id:'tiposEvaluacion', label:'Tipos de Evaluación', type:'modal-multiselect' }, { id:'criteriosCalificacion', label:'Criterios de Calificación', type:'textarea' }, { id:'recursos', label:'Recursos', type:'textarea' },
                ]},
                { step:5, legend: 'Marco Pedagógico (Automático)', fields:[
                    { id:'competenciaEspecifica', label:'Competencia Específica', type:'readonly-textarea' }, { id:'descriptoresOperativos', label:'Descriptores Operativos', type:'readonly-textarea' }, { id:'competenciasClave', label:'Competencias Clave', type:'readonly-textarea' }, { id:'contenidosTransversales', label:'Contenidos Transversales', type:'modal-multiselect' },
                ]},
                { step:5, legend: 'Atención a la Diversidad', fields:[
                    { id:'dua', label:'DUA', type:'dua-group' }, { id:'adaptacion', label:'Adaptación', type:'textarea' },
                ]},
                { step:5, legend: 'Observaciones', fields:[
                    { id:'observaciones', label:'Observaciones y notas adicionales', type:'textarea' },
                ]},
            ];
            
            fieldsets.forEach(fs => {
                const fsEl = document.createElement('fieldset'); fsEl.className = 'border border-slate-200 p-4 rounded-lg';
                const legend = document.createElement('legend'); legend.className = 'text-md font-semibold px-2 text-slate-600'; legend.textContent = fs.legend; fsEl.appendChild(legend);
                const grid = document.createElement('div');
                grid.className = fs.fields.length > 2 ? 'grid grid-cols-1 md:grid-cols-2 gap-4' : 'grid grid-cols-1 gap-4';
                
                fs.fields.forEach(f => {
                    let fieldWrapper;
                    if (f.type === 'ud-selector') {
                        fieldWrapper = document.createElement('div');
                        fieldWrapper.innerHTML = `
                            <label class="block text-sm font-medium text-slate-700 mb-1">${f.label}</label>
                            <div class="flex items-center gap-4">
                                <span id="ud-display" class="w-full p-2 border border-slate-300 rounded-md bg-slate-50 h-10 flex items-center">No seleccionada</span>
                                <input type="hidden" id="${f.id}" name="${f.id}">
                                <button type="button" data-modal-trigger="ud" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-shrink-0">Seleccionar</button>
                            </div>
                        `;
                    } else if (f.type === 'modal-multiselect') {
                        fieldWrapper = document.createElement('div');
                        fieldWrapper.innerHTML = `
                            <label class="block text-sm font-medium text-slate-700 mb-1">${f.label}</label>
                            <div class="flex items-center gap-4">
                                <div id="${f.id}-display" class="w-full p-2 border border-slate-300 rounded-md bg-slate-50 min-h-[40px] flex items-center flex-wrap">
                                    <span class="text-slate-400">No seleccionado</span>
                                </div>
                                <input type="hidden" id="${f.id}" name="${f.id}" value="[]">
                                <button type="button" data-modal-trigger="${f.id}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-shrink-0">Seleccionar</button>
                            </div>
                        `;
                    } else {
                       fieldWrapper = ui.createFormField(f.id, f.label, f.type, f.options);
                    }
                    
                    if (['situacionAprendizaje', 'recursos', 'criteriosCalificacion'].includes(f.id)) {
                        fieldWrapper.classList.add('md:col-span-2');
                    }
                    grid.appendChild(fieldWrapper);
                });

                fsEl.appendChild(grid);
                if(fs.step === 1) step1.appendChild(fsEl);
                if(fs.step === 2) step2.appendChild(fsEl);
                if(fs.step === 3) step3.appendChild(fsEl);
                if(fs.step === 4) step4.appendChild(fsEl);
                if(fs.step === 5) step5.appendChild(fsEl);
            });

            const continueBtn1 = document.createElement('button'); continueBtn1.type = 'button'; continueBtn1.id = 'continue-btn-1'; continueBtn1.textContent = 'Continuar'; continueBtn1.className = 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors'; 
            step1.appendChild(continueBtn1);

            const navStep2 = document.createElement('div'); navStep2.className = 'flex justify-between mt-6';
            const backBtn2 = document.createElement('button'); backBtn2.type = 'button'; backBtn2.id = 'back-btn-2'; backBtn2.textContent = 'Atrás'; backBtn2.className = 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors';
            const continueBtn2 = document.createElement('button'); continueBtn2.type = 'button'; continueBtn2.id = 'continue-btn-2'; continueBtn2.textContent = 'Continuar'; continueBtn2.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors'; 
            navStep2.appendChild(backBtn2);
            navStep2.appendChild(continueBtn2);
            step2.appendChild(navStep2);

            const navStep3 = document.createElement('div'); navStep3.className = 'flex justify-between mt-6';
            const backBtn3 = document.createElement('button'); backBtn3.type = 'button'; backBtn3.id = 'back-btn-3'; backBtn3.textContent = 'Atrás'; backBtn3.className = 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors';
            const continueBtn3 = document.createElement('button'); continueBtn3.type = 'button'; continueBtn3.id = 'continue-btn-3'; continueBtn3.textContent = 'Continuar'; continueBtn3.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors'; 
            navStep3.appendChild(backBtn3);
            navStep3.appendChild(continueBtn3);
            step3.appendChild(navStep3);
            
            const navStep4 = document.createElement('div'); navStep4.className = 'flex justify-between mt-6';
            const backBtn4 = document.createElement('button'); backBtn4.type = 'button'; backBtn4.id = 'back-btn-4'; backBtn4.textContent = 'Atrás'; backBtn4.className = 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors';
            const continueBtn4 = document.createElement('button'); continueBtn4.type = 'button'; continueBtn4.id = 'continue-btn-4'; continueBtn4.textContent = 'Continuar'; continueBtn4.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors'; 
            navStep4.appendChild(backBtn4);
            navStep4.appendChild(continueBtn4);
            step4.appendChild(navStep4);

            const navStep5 = document.createElement('div'); navStep5.className = 'mt-6';
            const backBtn5 = document.createElement('button'); backBtn5.type = 'button'; backBtn5.id = 'back-btn-5'; backBtn5.textContent = 'Atrás'; backBtn5.className = 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors';
            navStep5.appendChild(backBtn5);
            step5.appendChild(navStep5);

            const infoSummary = document.createElement('div'); infoSummary.id = 'info-summary'; infoSummary.className = 'hidden mb-4'; 
            step2.prepend(infoSummary.cloneNode(true));
            step3.prepend(infoSummary.cloneNode(true));
            step4.prepend(infoSummary.cloneNode(true));
            step5.prepend(infoSummary.cloneNode(true));

            form.appendChild(step1); 
            form.appendChild(step2);
            form.appendChild(step3);
            form.appendChild(step4);
            form.appendChild(step5);
            form.addEventListener('change', (e) => { if (e.target.name === 'criteriosEvaluacion') ui.updateDerivedFields(); app.triggerAutoSave(); });
        },

        renderSessionList(sessionsToRender = state.allSessions) {
            const sessionList = document.getElementById('session-list');
            const template = document.getElementById('template-session-item');
            sessionList.innerHTML = '';
            if (!sessionsToRender.length) {
                sessionList.innerHTML = '<p class="text-center text-slate-500 p-4">No se encontraron sesiones.</p>';
                return;
            }
            sessionsToRender.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            sessionsToRender.forEach(session => {
                const clone = template.content.cloneNode(true);
                const div = clone.querySelector('div');
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = session.situacionAprendizaje || '';
                const title = tempDiv.textContent.split('\n')[0] || 'Sin título';
                const subtitle = `${session.materia?.[0] || 'Sin materia'} - ${session.curso?.[0] || 'Sin curso'}`;
                
                div.dataset.id = session.id;
                div.classList.toggle('bg-blue-100', state.currentSessionId === session.id);
                div.classList.toggle('border-blue-500', state.currentSessionId === session.id);
                clone.querySelector('[data-template="title"]').textContent = title;
                clone.querySelector('[data-template="subtitle"]').textContent = subtitle;
                div.addEventListener('click', () => app.displaySession(session.id));
                sessionList.appendChild(clone);
            });
        },

        populateForm(data) {
            const form = document.getElementById('session-form');
            form.reset();
            
            const parseArrayData = (value) => {
                if (Array.isArray(value)) return value;
                if (typeof value !== 'string' || !value) return [];
                if (value.startsWith('[') && value.endsWith(']')) {
                    try { return JSON.parse(value); } catch (e) { /* fall through */ }
                }
                return value.split(',');
            };

            for (const key in data) {
                if (key === 'unidadDidactica') {
                    const value = data[key];
                    document.getElementById('unidadDidactica').value = value || '';
                    document.getElementById('ud-display').textContent = value ? `Unidad ${value}` : 'No seleccionada';
                } else if (['materia', 'curso', 'sesionNum', 'tiposEvaluacion', 'contenidosTransversales', 'contenidos'].includes(key)) {
                    const values = parseArrayData(data[key]);
                    document.getElementById(key).value = JSON.stringify(values);
                    ui.updateChipsDisplay(key, values);
                } else if (state.editors[key]) {
                    let content = data[key] || '';
                    if (Array.isArray(content)) {
                        content = content.join('<br>');
                    }
                    state.editors[key].setContents(String(content));
                } else {
                    const field = form.elements[key];
                    if (field) {
                        if (key === 'fecha' && data[key]) {
                            field.value = new Date(data[key]).toISOString().split('T')[0];
                        } else {
                            field.value = data[key] || '';
                        }
                    } else if (key === 'criteriosEvaluacion' || key === 'dua') {
                        const saved = parseArrayData(data[key]);
                        document.querySelectorAll(`input[name="${key}"]`).forEach(cb => {
                            cb.checked = saved.includes(cb.value);
                        });
                    }
                }
            }
            document.getElementById('selectedDuaGuidelines').value = JSON.stringify(parseArrayData(data.duaGuidelines));
            ui.updateDerivedFields();
        },
        
        printReport() {
            if (!state.currentSessionId) {
                ui.showModal('Aviso', 'Por favor, guarda la sesión antes de imprimir.');
                return;
            }
            const data = state.allSessions.find(s => s.id === state.currentSessionId);
            if (!data) return;

            const printArea = document.getElementById('print-area');
            const createIcon = (path) => `<svg class="w-6 h-6 mr-3 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${path}</svg>`;
            const icons = {
                situacion: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),
                actividades: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.085a2 2 0 00-1.736.97l-1.9 3.8a2 2 0 00.23 2.16l3.5 3.5m7-10L7 5"></path>'),
                evaluacion: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),
                marco: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h1a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 16.95l.826.826m8.334-8.334l.826.826m-1.06-7.553l.267.267m-1.623 1.623l.267.267M16.95 7.737l.826.826M12 21a9 9 0 100-18 9 9 0 000 18z"></path>'),
                diversidad: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>'),
                info: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),
                observaciones: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.586a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>')
            };
            const createList = (items) => !items || items.length === 0 ? '<p class="text-slate-500 italic mt-2">No especificado</p>' : `<ul class="list-disc list-inside space-y-1 mt-2 pl-2">${items.map(i => `<li>${i}</li>`).join('')}</ul>`;
            const createText = (content) => {
                const strContent = String(content || '');
                return !strContent || strContent.trim() === '' || strContent.trim() === '<p><br></p>' 
                    ? '<p class="text-slate-500 italic mt-2">No especificado</p>' 
                    : `<div class="prose prose-sm max-w-none mt-2">${strContent}</div>`;
            };
            
            const createCard = (templateId, title, icon, content) => {
                const template = document.getElementById(templateId);
                if (!template) return '';
                const clone = template.content.cloneNode(true);
                clone.querySelector('[data-template="title"]').textContent = title;
                clone.querySelector('[data-template="icon-container"]').innerHTML = icon;
                clone.querySelector('[data-template="content"]').innerHTML = content;
                return clone.firstElementChild.outerHTML;
            };

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.situacionAprendizaje || '';
            const situacionTitle = tempDiv.textContent.split('\n')[0] || 'Situación de Aprendizaje sin Título';
            const situacionBody = data.situacionAprendizaje || '';

            const actividadesContent = [data.actividad1, data.actividad2, data.actividad3, data.actividad4].map((act, i) => act && act.trim() !== '<p><br></p>' ? `<div><strong class="font-semibold text-slate-700">Actividad ${i + 1}:</strong>${createText(act)}</div>` : '').filter(Boolean).join('<hr class="my-4 border-slate-200">');
            const evaluacionContent = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><strong class="font-semibold text-slate-700">Criterios de Evaluación:</strong>${createList(data.criteriosEvaluacion)}</div><div><strong class="font-semibold text-slate-700">Instrumentos:</strong>${createText(data.instrumentosEvaluacion)}</div><div><strong class="font-semibold text-slate-700">Tipos de Evaluación:</strong>${createList(data.tiposEvaluacion)}</div><div><strong class="font-semibold text-slate-700">Criterios de Calificación:</strong>${createText(data.criteriosCalificacion)}</div><div class="md:col-span-2"><strong class="font-semibold text-slate-700">Recursos:</strong>${createText(data.recursos)}</div></div>`;
            const marcoContent = `<strong class="font-semibold text-slate-700">Competencia Específica:</strong>${createText(data.competenciaEspecifica)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Descriptores Operativos:</strong>${createText(data.descriptoresOperativos)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Competencias Clave:</strong>${createText(data.competenciasClave)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Contenidos Transversales:</strong>${createList(data.contenidosTransversales)}`;
            const duaGuidelines = data.duaGuidelines && data.duaGuidelines.length ? `<div><strong class="font-semibold text-slate-700 mt-4 block">Pautas Específicas:</strong>${createList(data.duaGuidelines)}</div>` : '';
            const diversidadContent = `<strong class="font-semibold text-slate-700">Principios DUA:</strong>${createList(data.dua)}${duaGuidelines}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Adaptaciones:</strong>${createText(data.adaptacion)}`;
            const observacionesContent = data.observaciones && data.observaciones.trim() !== '' ? createText(data.observaciones) : `<div class="h-48"></div>`;
            const fecha = data.fecha ? new Date(data.fecha).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }) : 'No especificada';
            const infoGeneralContent = `<strong class="font-semibold text-slate-700">Fecha:</strong><p class="mt-1 mb-3 pl-2">${fecha}</p><strong class="font-semibold text-slate-700">Materia(s):</strong>${createList(data.materia)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Curso(s):</strong>${createList(data.curso)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Sesión(es):</strong>${createList(data.sesionNum)}`;
            
            printArea.innerHTML = `<div class="p-8 bg-slate-50 font-sans"><header class="text-center mb-10"><h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">Programación de Sesión</h1><p class="mt-2 text-lg text-slate-500">Informe Detallado</p></header>${createCard('template-print-card', 'Sesión de Aprendizaje', icons.situacion, `<h2 class="text-2xl font-bold text-indigo-700">${situacionTitle}</h2><div class="prose prose-slate max-w-none mt-4">${situacionBody}</div>`)}<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">${createCard('template-print-sidebar-card','Información General', icons.info, infoGeneralContent)}${createCard('template-print-sidebar-card','Marco Pedagógico', icons.marco, marcoContent)}</div>${createCard('template-print-card', 'Secuencia de Actividades', icons.actividades, actividadesContent || createText(null))}<div class="mt-2">${createCard('template-print-card','Estrategia de Evaluación', icons.evaluacion, evaluacionContent)}${createCard('template-print-card','Atención a la Diversidad', icons.diversidad, diversidadContent)}${createCard('template-print-card','Observaciones', icons.observaciones, observacionesContent)}</div><footer class="text-center mt-10 pt-6 border-t border-slate-200"><p class="text-sm text-slate-500">Informe generado con el Planificador Didáctico - ${new Date().toLocaleDateString('es-ES')}</p></footer></div>`;
            window.print();
        }
    };

    // =============================
    // MODULE: APP
    // =============================
    const app = {
        async loadSessions() {
            const sessionList = document.getElementById('session-list');
            sessionList.innerHTML = '<div id="loading-sessions" class="p-4 text-center text-slate-500">Cargando sesiones...</div>';
            try {
                state.allSessions = await api.call('getSessions');
                ui.renderSessionList();
            } catch (error) {
                console.error('Error detallado al cargar sesiones:', error);
                const loadingEl = document.getElementById('loading-sessions');
                if (loadingEl) {
                    loadingEl.textContent = 'Error al cargar sesiones.';
                }
                ui.showModal('Error de Conexión', `No se pudieron cargar las sesiones. Detalles: ${error.message}. Comprueba que el despliegue del script es "Anyone" y vuelve a desplegar tras cambios.`);
            }
        },

        displaySession(sessionId) {
            const sessionData = state.allSessions.find(s => s.id === sessionId);
            if (!sessionData) return;

            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('session-form').style.display = 'block';
            document.getElementById('action-buttons').classList.add('hidden');
            document.getElementById('form-step-1').classList.add('hidden');
            document.getElementById('form-step-2').classList.add('hidden');
            document.getElementById('form-step-3').classList.remove('hidden');
            document.getElementById('form-step-4').classList.add('hidden');
            document.getElementById('form-step-5').classList.add('hidden');

            ui.ensureEditorsInitialized(config.allEditorIds);
            state.currentSessionId = sessionId;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = sessionData.situacionAprendizaje || '';
            const title = tempDiv.textContent.split('\n')[0] || 'Sin título';
            document.getElementById('form-title').textContent = 'Paso 3: Actividades';
            document.querySelectorAll('#session-list > div').forEach(div => { div.classList.toggle('bg-blue-100', div.dataset.id === state.currentSessionId); div.classList.toggle('border-blue-500', div.dataset.id === state.currentSessionId); });

            const autoSavedDataRaw = localStorage.getItem(`autosave_${sessionId}`);
            if (autoSavedDataRaw) {
                const autoSavedData = JSON.parse(autoSavedDataRaw);
                ui.showModal('Restaurar Sesión', 'Se han encontrado datos autoguardados para esta sesión. ¿Quieres restaurarlos?', {
                    buttons: [
                        { text: 'No, usar versión guardada', class: 'bg-slate-500', callback: () => { ui.populateForm(sessionData); ui.renderInfoSummary(); } },
                        { text: 'Sí, restaurar', class: 'bg-blue-500', callback: () => { ui.populateForm(autoSavedData); ui.renderInfoSummary(); } }
                    ]
                });
            } else {
                ui.populateForm(sessionData);
            }

            ui.renderInfoSummary();
        },

        clearForm() {
            document.getElementById('welcome-message').style.display = 'none';
            document.getElementById('session-form').style.display = 'block';
            document.getElementById('action-buttons').classList.add('hidden');
            document.getElementById('form-step-1').classList.remove('hidden');
            document.getElementById('form-step-2').classList.add('hidden');
            document.getElementById('form-step-3').classList.add('hidden');
            document.getElementById('form-step-4').classList.add('hidden');
            document.getElementById('form-step-5').classList.add('hidden');
            state.currentSessionId = null;

            ui.ensureEditorsInitialized(['situacionAprendizaje']);
            document.getElementById('form-title').textContent = 'Paso 1: Información General';
            document.querySelectorAll('#session-list > div').forEach(div => div.classList.remove('bg-blue-100', 'border-blue-500'));
            const summary = document.getElementById('info-summary'); if (summary) { summary.classList.add('hidden'); summary.innerHTML = ''; }

            const autoSavedDataRaw = localStorage.getItem('autosave_new');
            if (autoSavedDataRaw) {
                const autoSavedData = JSON.parse(autoSavedDataRaw);
                ui.showModal('Restaurar Borrador', 'Se ha encontrado un borrador no guardado. ¿Quieres restaurarlo?', {
                    buttons: [
                        { text: 'No, empezar de cero', class: 'bg-slate-500', callback: () => { localStorage.removeItem('autosave_new'); ui.populateForm({}); } },
                        { text: 'Sí, restaurar', class: 'bg-blue-500', callback: () => ui.populateForm(autoSavedData) }
                    ]
                });
            } else {
                ui.populateForm({});
            }
        },

        getFormData() {
            const form = document.getElementById('session-form');
            const data = { id: state.currentSessionId };
            
            const formFields = ['fecha', 'unidadDidactica', 'competenciaEspecifica', 'descriptoresOperativos', 'competenciasClave'];
            const multiSelectFields = ['materia', 'curso', 'sesionNum', 'tiposEvaluacion', 'contenidosTransversales', 'contenidos'];
            const editorFields = config.allEditorIds;

            // Get values from simple form fields
            formFields.forEach(id => {
                if (form.elements[id]) {
                    data[id] = form.elements[id].value;
                }
            });

            // Get values from multi-select hidden inputs
            multiSelectFields.forEach(id => { 
                if (form.elements[id]) {
                    data[id] = JSON.parse(form.elements[id].value || '[]');
                }
            });

            // Get values from SunEditor instances
            editorFields.forEach(id => {
                if (state.editors[id] && state.editors[id].core) {
                    data[id] = state.editors[id].getContents(true);
                }
            });

            // Get values from checkbox groups
            data.criteriosEvaluacion = Array.from(document.querySelectorAll('input[name="criteriosEvaluacion"]:checked')).map(cb => cb.value);
            data.dua = Array.from(document.querySelectorAll('input[name="dua"]:checked')).map(cb => cb.value);
            data.duaGuidelines = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
            
            return data;
        },

        async saveSession() {
            const data = app.getFormData();
            ui.showModal('Guardando...', '', { showSpinner: true, buttons: [] });
            try {
                const r = await api.call('saveSession', { data });
                const savedId = r.id;

                localStorage.removeItem(`autosave_${state.currentSessionId || 'new'}`);
                if (state.currentSessionId === null) localStorage.removeItem('autosave_new');

                state.currentSessionId = savedId;
                document.getElementById('autosave-status').textContent = '';
                document.getElementById('autosave-status').classList.add('opacity-0');

                ui.showModal('Éxito', '¡Sesión guardada correctamente!');
                await app.loadSessions();

                const sessionData = state.allSessions.find(s => s.id === savedId);
                if (sessionData) {
                    document.querySelectorAll('#session-list > div').forEach(div => { div.classList.toggle('bg-blue-100', div.dataset.id === savedId); div.classList.toggle('border-blue-500', div.dataset.id === savedId); });
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = sessionData.situacionAprendizaje || '';
                    const title = tempDiv.textContent.split('\n')[0] || 'Sin título';
                    document.getElementById('form-title').textContent = `Editando: ${title}`;
                }
            } catch (error) {
                console.error('Error al guardar', error);
                ui.showModal('Error', `Hubo un problema al guardar la sesión: ${error.message}`);
            }
        },

        async deleteSession() {
            if (!state.currentSessionId) return;
            ui.showModal('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar esta sesión?', {
                buttons: [
                    { text: 'Cancelar', class: 'bg-slate-500 hover:bg-slate-600', callback: ui.hideModal },
                    { text: 'Sí, Eliminar', class: 'bg-red-500 hover:bg-red-600', callback: async () => {
                        ui.showModal('Eliminando...', '', { showSpinner: true, buttons: [] });
                        try {
                            await api.call('deleteSession', { id: state.currentSessionId });
                            localStorage.removeItem(`autosave_${state.currentSessionId}`);
                            app.clearForm();
                            document.getElementById('session-form').style.display = 'none';
                            document.getElementById('welcome-message').style.display = 'block';
                            ui.showModal('Éxito', 'Sesión eliminada.');
                            app.loadSessions();
                        } catch (error) {
                            console.error('Error al eliminar', error);
                            ui.showModal('Error', `No se pudo eliminar la sesión: ${error.message}`);
                        }
                    }}
                ]
            });
        },

        duplicateSession() {
            if (!state.currentSessionId) {
                ui.showModal('Aviso', 'Por favor, selecciona una sesión para duplicar.');
                return;
            }
            const s = state.allSessions.find(x => x.id === state.currentSessionId);
            if (!s) return;

            ui.ensureEditorsInitialized(config.allEditorIds);
            ui.populateForm(s);
            state.currentSessionId = null;

            const titleContent = state.editors['situacionAprendizaje'].getContents(true);
            state.editors['situacionAprendizaje'].setContents(`[COPIA] ${titleContent}`);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = s.situacionAprendizaje || '';
            const title = tempDiv.textContent.split('\n')[0] || 'Sin título';
            document.getElementById('form-title').textContent = `Duplicando: ${title}`;

            document.getElementById('form-step-1').classList.add('hidden');
            document.getElementById('form-step-2').classList.remove('hidden');
            document.getElementById('form-step-3').classList.remove('hidden');
            document.getElementById('continue-btn-1').classList.add('hidden');
            document.getElementById('continue-btn-2').classList.add('hidden');
            document.getElementById('action-buttons').classList.remove('hidden');
            ui.renderInfoSummary();
            ui.showModal('Sesión Duplicada', 'Se han copiado los datos. Revisa la información y pulsa "Guardar" para crear la nueva sesión.');
        },

        handleSearch(event) {
            event.preventDefault();
            const form = document.getElementById('search-form');
            const filters = {
                materia: Array.from(form.elements['materia'].selectedOptions).map(o => o.value),
                curso: Array.from(form.elements['curso'].selectedOptions).map(o => o.value),
                sesionNum: Array.from(form.elements['sesionNum'].selectedOptions).map(o => o.value),
                situacionAprendizaje: form.elements['situacionAprendizaje'].value.toLowerCase(),
                fechaDesde: form.elements['fechaDesde'].value,
                fechaHasta: form.elements['fechaHasta'].value
            };

            const filteredSessions = state.allSessions.filter(session => {
                const titleMatch = !filters.situacionAprendizaje || (session.situacionAprendizaje || '').toLowerCase().includes(filters.situacionAprendizaje);
                const materiaMatch = filters.materia.length === 0 || (session.materia || []).some(m => filters.materia.includes(m));
                const cursoMatch = filters.curso.length === 0 || (session.curso || []).some(c => filters.curso.includes(c));
                const sesionMatch = filters.sesionNum.length === 0 || (session.sesionNum || []).some(s => filters.sesionNum.includes(s));
                
                const sessionDate = session.fecha;
                let dateMatch = true;
                if (filters.fechaDesde && sessionDate) { dateMatch = dateMatch && (sessionDate >= filters.fechaDesde); }
                if (filters.fechaHasta && sessionDate) { dateMatch = dateMatch && (sessionDate <= filters.fechaHasta); }
                if ((filters.fechaDesde || filters.fechaHasta) && !sessionDate) { dateMatch = false; }

                return titleMatch && materiaMatch && cursoMatch && sesionMatch && dateMatch;
            });

            ui.renderSessionList(filteredSessions);
            ui.hideSearchModal();
        },

        clearSearch() {
            document.getElementById('search-form').reset();
            ui.renderSessionList();
        },

        saveDuaGuidelines() {
            const newly = Array.from(document.querySelectorAll('#dua-modal-content input[type="checkbox"]:checked')).map(cb => cb.value);
            const prev = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
            const currentGroup = config.duaData[state.currentDuaPrincipleKey].guidelines.map(g => g.text);
            const other = prev.filter(t => !currentGroup.includes(t));
            document.getElementById('selectedDuaGuidelines').value = JSON.stringify([...other, ...newly]);
            app.triggerAutoSave();
            ui.hideDuaModal();
        },

        saveMultiSelect() {
            const type = state.currentMultiSelect;
            if (!type) return;
            
            const selectedValues = Array.from(document.querySelectorAll(`#multi-select-modal-content input[type="checkbox"]:checked`)).map(cb => cb.value);
            document.getElementById(type).value = JSON.stringify(selectedValues);
            ui.updateChipsDisplay(type, selectedValues);
            app.triggerAutoSave();
            ui.hideMultiSelectModal();
        },

        triggerAutoSave() {
            const statusEl = document.getElementById('autosave-status');
            statusEl.textContent = 'Guardando...';
            statusEl.classList.remove('opacity-0');
            clearTimeout(state.autoSaveTimer);
            state.autoSaveTimer = setTimeout(() => {
                const data = app.getFormData();
                const key = `autosave_${state.currentSessionId || 'new'}`;
                localStorage.setItem(key, JSON.stringify(data));
                statusEl.textContent = 'Guardado ✓';
                setTimeout(() => statusEl.classList.add('opacity-0'), 2000);
            }, 1500);
        },

        init() {
            ui.buildForm();
            const form = document.getElementById('session-form');
            form.style.display = 'none';
            if (config.SCRIPT_URL.includes('Pega aquí')) {
                ui.showModal('Configuración Requerida', 'Debes editar el archivo HTML y pegar la URL de tu script de Google para que la aplicación funcione.');
            } else {
                app.loadSessions();
            }

            document.getElementById('new-session-btn').addEventListener('click', app.clearForm);
            document.getElementById('save-btn').addEventListener('click', app.saveSession);
            document.getElementById('delete-btn').addEventListener('click', app.deleteSession);
            document.getElementById('print-btn').addEventListener('click', ui.printReport);
            document.getElementById('duplicate-btn').addEventListener('click', app.duplicateSession);
            
            document.getElementById('continue-btn-1').addEventListener('click', () => {
                ui.ensureEditorsInitialized(config.allEditorIds);
                ui.renderInfoSummary();
                document.getElementById('form-step-1').classList.add('hidden');
                document.getElementById('form-step-2').classList.remove('hidden');
                document.getElementById('form-title').textContent = 'Paso 2: Detalles de la Sesión';
            });
            
            document.getElementById('continue-btn-2').addEventListener('click', () => {
                ui.ensureEditorsInitialized(config.allEditorIds);
                ui.renderInfoSummary();
                document.getElementById('form-step-2').classList.add('hidden');
                document.getElementById('form-step-3').classList.remove('hidden');
                document.getElementById('form-title').textContent = 'Paso 3: Actividades';
            });
            
            document.getElementById('continue-btn-3').addEventListener('click', () => {
                ui.ensureEditorsInitialized(config.allEditorIds);
                ui.renderInfoSummary();
                document.getElementById('form-step-3').classList.add('hidden');
                document.getElementById('form-step-4').classList.remove('hidden');
                document.getElementById('form-title').textContent = 'Paso 4: Evaluación';
            });

            document.getElementById('continue-btn-4').addEventListener('click', () => {
                ui.ensureEditorsInitialized(config.allEditorIds);
                ui.renderInfoSummary();
                document.getElementById('form-step-4').classList.add('hidden');
                document.getElementById('form-step-5').classList.remove('hidden');
                document.getElementById('action-buttons').classList.remove('hidden');
                document.getElementById('form-title').textContent = 'Paso 5: Marco Pedagógico y Diversidad';
            });

            document.getElementById('back-btn-2').addEventListener('click', () => {
                document.getElementById('form-step-2').classList.add('hidden');
                document.getElementById('form-step-1').classList.remove('hidden');
                document.getElementById('form-title').textContent = 'Paso 1: Información General';
            });

            document.getElementById('back-btn-3').addEventListener('click', () => {
                document.getElementById('form-step-3').classList.add('hidden');
                document.getElementById('form-step-2').classList.remove('hidden');
                document.getElementById('form-title').textContent = 'Paso 2: Detalles de la Sesión';
            });
            
            document.getElementById('back-btn-4').addEventListener('click', () => {
                document.getElementById('form-step-4').classList.add('hidden');
                document.getElementById('form-step-3').classList.remove('hidden');
                document.getElementById('form-title').textContent = 'Paso 3: Actividades';
            });

            document.getElementById('back-btn-5').addEventListener('click', () => {
                document.getElementById('form-step-5').classList.add('hidden');
                document.getElementById('form-step-4').classList.remove('hidden');
                document.getElementById('action-buttons').classList.add('hidden');
                document.getElementById('form-title').textContent = 'Paso 4: Evaluación';
            });

            document.getElementById('dua-modal-cancel').addEventListener('click', ui.hideDuaModal);
            document.getElementById('dua-modal-save').addEventListener('click', app.saveDuaGuidelines);
            
            document.getElementById('search-session-btn').addEventListener('click', ui.showSearchModal);
            document.getElementById('search-cancel-btn').addEventListener('click', ui.hideSearchModal);
            document.getElementById('search-form').addEventListener('submit', app.handleSearch);
            document.getElementById('search-clear-btn').addEventListener('click', app.clearSearch);
            
            document.getElementById('ud-modal-cancel').addEventListener('click', ui.hideUdModal);
            document.getElementById('multi-select-modal-cancel').addEventListener('click', ui.hideMultiSelectModal);
            document.getElementById('multi-select-modal-save').addEventListener('click', app.saveMultiSelect);

            document.getElementById('session-form').addEventListener('click', (e) => {
                const trigger = e.target.closest('[data-modal-trigger]');
                if (trigger) {
                    const type = trigger.dataset.modalTrigger;
                    if (type === 'ud') {
                        ui.showUdModal();
                    } else {
                        ui.showMultiSelectModal(type);
                    }
                }
            });
        }
    };

    // =============================
    // ENTRY POINT
    // =============================
    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>
