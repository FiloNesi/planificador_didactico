<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificador Didáctico de Filosofía</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@2.3.0/build/vanilla-js-calendar.min.css" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    select[multiple] { padding: 0.5rem; }
    .checkbox-group { max-height: 20rem; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* --- ESTILOS PARA LA NAVEGACIÓN POR PASOS --- */
    #step-navigator .step-item { transition: all 0.2s ease-in-out; }
    #step-navigator .step-icon { transition: all 0.2s ease-in-out; }
    #step-navigator .step-item.step-active .step-icon { background-color: #4f46e5; border-color: #4f46e5; color: white; }
    #step-navigator .step-item.step-active .step-title { color: #4f46e5; font-weight: 600; }
    #step-navigator .step-item.step-completed { cursor: pointer; }
    #step-navigator .step-item.step-completed .step-icon { background-color: #16a34a; border-color: #16a34a; color: white; }
    #step-navigator .step-item.step-completed:hover .step-title { color: #1e293b; }
    #step-navigator .step-item.step-disabled { cursor: not-allowed; opacity: 0.6; }

    /* --- ESTILOS PARA EL CALENDARIO DEL DASHBOARD --- */
    .vanilla-js-calendar { width: 100%; box-shadow: none; border: 1px solid #e2e8f0; }
    .vanilla-js-calendar .vanilla-js-calendar-day_selected { background-color: #4f46e5; color: white; }
    .vanilla-js-calendar .vanilla-js-calendar-day_marked { background-color: #a5b4fc; border-radius: 50%; }


    /* Estilos para la impresión */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; -webkit-print-color-adjust: exact; color-adjust: exact; }
      .no-print { display: none; }
    }
    /* Clases de Prosa para Tailwind, para el contenido del informe */
    .prose { color: #334155; max-width: 65ch; }
    .prose a { color: #4f46e5; text-decoration: underline; }
    .prose strong { color: #1e293b; font-weight: 600; }
    .prose blockquote { border-left-color: #e2e8f0; }
    .prose thead { border-bottom-color: #e2e8f0; }
    .prose-sm { font-size: 0.875rem; line-height: 1.5; }
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div id="app-container" class="flex flex-col h-screen">
    <header class="bg-white shadow-md p-3 flex justify-between items-center no-print flex-shrink-0">
      <h1 class="text-xl font-bold text-slate-700">Planificador Didáctico</h1>
    </header>
    <main class="flex-grow flex flex-col md:flex-row gap-3 p-3 overflow-hidden no-print">
      <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-4 border-b flex justify-between items-center gap-2">
          <h2 class="text-lg font-semibold">Sesiones</h2>
          <div class="flex gap-2">
            <button id="search-session-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold p-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
            </button>
            <button id="new-session-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Nueva</button>
          </div>
        </div>
        <div id="session-list" class="overflow-y-auto flex-grow p-2"></div>
      </aside>
      <section class="w-full md:w-2/3 lg:w-3/4 flex bg-white rounded-lg shadow-md overflow-hidden">
        <div id="form-wrapper" class="w-full flex-row hidden">
            <nav id="step-navigator" class="w-64 border-r border-slate-200 p-6 bg-slate-50 flex-shrink-0">
                <ol>
                    <li data-step="1" class="step-item mb-6"><div class="flex items-center"><span class="step-icon flex items-center justify-center w-8 h-8 rounded-full border-2 border-slate-400 text-slate-500 font-bold">1</span><span class="step-title ml-3 font-medium text-slate-600">Información</span></div></li>
                    <li data-step="2" class="step-item mb-6"><div class="flex items-center"><span class="step-icon flex items-center justify-center w-8 h-8 rounded-full border-2 border-slate-400 text-slate-500 font-bold">2</span><span class="step-title ml-3 font-medium text-slate-600">Detalles</span></div></li>
                    <li data-step="3" class="step-item mb-6"><div class="flex items-center"><span class="step-icon flex items-center justify-center w-8 h-8 rounded-full border-2 border-slate-400 text-slate-500 font-bold">3</span><span class="step-title ml-3 font-medium text-slate-600">Actividades</span></div></li>
                    <li data-step="4" class="step-item mb-6"><div class="flex items-center"><span class="step-icon flex items-center justify-center w-8 h-8 rounded-full border-2 border-slate-400 text-slate-500 font-bold">4</span><span class="step-title ml-3 font-medium text-slate-600">Evaluación</span></div></li>
                    <li data-step="5" class="step-item"><div class="flex items-center"><span class="step-icon flex items-center justify-center w-8 h-8 rounded-full border-2 border-slate-400 text-slate-500 font-bold">5</span><span class="step-title ml-3 font-medium text-slate-600">Marco y DUA</span></div></li>
                </ol>
            </nav>
            <div class="flex-grow flex flex-col overflow-hidden">
                <div id="form-header" class="p-3 border-b flex justify-between items-center flex-wrap gap-2 flex-shrink-0">
                    <h2 id="form-title" class="text-lg font-semibold">Selecciona una sesión o crea una nueva</h2>
                    <div class="flex items-center gap-2">
                        <span id="autosave-status" class="text-sm text-slate-500 transition-opacity duration-300 opacity-0"></span>
                        <div id="action-buttons" class="flex gap-2 hidden">
                            <button id="save-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button>
                            <button id="duplicate-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Duplicar</button>
                            <button id="export-calendar-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                Exportar</button>
                            <button id="print-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Imprimir</button>
                            <button id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Eliminar</button>
                        </div>
                    </div>
                </div>
                <div id="form-container" class="overflow-y-auto flex-grow p-4">
                    <form id="session-form" class="grid grid-cols-1 lg:grid-cols-2 gap-x-6 gap-y-4"></form>
                </div>
            </div>
        </div>
        <div id="welcome-message" class="w-full p-6 md:p-8 overflow-y-auto">
            <h2 class="text-2xl font-bold text-slate-800">Bienvenido a tu Planificador</h2>
            <p class="mt-1 text-slate-500">Organiza tus clases, gestiona tus sesiones y enfócate en lo que más importa: enseñar.</p>
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <button id="dashboard-new-session-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg text-lg flex items-center justify-center transition-transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Crear Nueva Sesión
                    </button>
                    <div class="mt-8">
                        <h3 class="text-lg font-semibold text-slate-700">Acceso Rápido</h3>
                        <p class="text-sm text-slate-500 mb-4">Continúa donde lo dejaste.</p>
                        <div id="recent-sessions-container" class="space-y-3"></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-slate-700">Calendario de Sesiones</h3>
                    <p class="text-sm text-slate-500 mb-4">Tus clases planificadas de un vistazo.</p>
                    <div id="calendar-container"></div>
                </div>
            </div>
        </div>
      </section>
    </main>
  </div>
  <div id="print-area"></div>

    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print"><div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3 mx-auto flex flex-col items-center text-center"><div id="modal-spinner" class="spinner hidden mb-4"></div><h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3><p id="modal-text" class="py-4 text-slate-600"></p><div id="modal-buttons" class="text-right space-x-2"></div></div></div>
  <div id="dua-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print"><div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto"><h3 id="dua-modal-title" class="text-xl font-bold text-slate-800"></h3><div id="dua-modal-content" class="py-4 space-y-2 max-h-96 overflow-y-auto"></div><div id="dua-modal-buttons" class="text-right space-x-2"><button id="dua-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button><button id="dua-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar Pautas</button></div></div></div>
  <div id="ud-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print"><div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto"><h3 class="text-xl font-bold text-slate-800 mb-4">Seleccionar Unidad Didáctica</h3><div id="ud-modal-content" class="grid grid-cols-3 sm:grid-cols-5 gap-4 py-4"></div><div class="text-right"><button id="ud-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button></div></div></div>
  <div id="multi-select-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print"><div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto"><h3 id="multi-select-modal-title" class="text-xl font-bold text-slate-800 mb-4"></h3><div id="multi-select-modal-content" class="grid grid-cols-1 md:grid-cols-2 gap-4 py-4 max-h-96 overflow-y-auto"></div><div class="text-right space-x-2"><button id="multi-select-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button><button id="multi-select-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button></div></div></div>
  <div id="search-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print"><div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 mx-auto"><h3 class="text-xl font-bold text-slate-800 mb-4">Buscar Sesiones</h3><form id="search-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="search-materia" class="block text-sm font-medium text-slate-700 mb-1">Materia</label><select id="search-materia" name="materia" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select></div><div><label for="search-curso" class="block text-sm font-medium text-slate-700 mb-1">Curso</label><select id="search-curso" name="curso" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select></div><div><label for="search-sesion" class="block text-sm font-medium text-slate-700 mb-1">Sesión</label><select id="search-sesion" name="sesionNum" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select></div><div><label for="search-titulo" class="block text-sm font-medium text-slate-700 mb-1">Título</label><input type="text" id="search-titulo" name="situacionAprendizaje" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Contiene el texto..."></div><div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="search-fecha-desde" class="block text-sm font-medium text-slate-700 mb-1">Fecha Desde</label><input type="date" id="search-fecha-desde" name="fechaDesde" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div><div><label for="search-fecha-hasta" class="block text-sm font-medium text-slate-700 mb-1">Fecha Hasta</label><input type="date" id="search-fecha-hasta" name="fechaHasta" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></div></div></div><div class="flex justify-end gap-2 pt-4 border-t"><button id="search-clear-btn" type="button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Limpiar</button><button id="search-cancel-btn" type="button" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button><button id="search-submit-btn" type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Buscar</button></div></form></div></div>
  <div id="bank-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print"><div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 mx-auto flex flex-col" style="max-height: 90vh;"><h3 id="bank-modal-title" class="text-2xl font-bold text-slate-800 mb-4 flex-shrink-0">Banco de Recursos</h3><div id="bank-modal-content" class="flex-grow overflow-y-auto pr-2"></div><div class="text-right pt-4 border-t flex-shrink-0"><button id="bank-modal-close" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cerrar</button></div></div></div>

    <template id="template-session-item"><div class="p-3 m-1 rounded-lg cursor-pointer border-l-4 transition-colors hover:bg-slate-100 border-transparent"><h3 class="font-semibold truncate" data-template="title"></h3><p class="text-sm text-slate-500" data-template="subtitle"></p></div></template>
  <template id="template-print-card"><div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 print:shadow-none print:border print:border-slate-200"><div class="p-6"><div class="flex items-center"><div data-template="icon-container"></div><h3 class="text-xl font-bold text-slate-800" data-template="title"></h3></div><div class="mt-4 text-slate-600 pl-9" data-template="content"></div></div></div></template>
  <template id="template-print-sidebar-card"><div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 print:shadow-none print:border print:border-slate-200"><div class="p-5"><div class="flex items-center border-b border-slate-200 pb-3 mb-3"><div data-template="icon-container"></div><h4 class="text-md font-bold text-slate-700" data-template="title"></h4></div><div class="text-sm text-slate-600" data-template="content"></div></div></div></template>

  <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanilla-js-calendar@2.3.0/build/vanilla-js-calendar.min.js"></script>

  <script type="module">
    // =============================
    // MODULES (config, state, api, bank, calendar, ui, app)
    // =============================
    const config = {
        SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyIClBck1KBGo7S4K3Hop1rkmSBNXjfP6MZ8Rsu714E_PIlNiZuimJfkH_j95HGKmSIZQ/exec",
        formStepTitles: ["Paso 1: Información General", "Paso 2: Detalles de la Sesión", "Paso 3: Actividades", "Paso 4: Evaluación", "Paso 5: Marco Pedagógico y Diversidad"],
        evaluationData: [{ id: "1.1", text: "1.1 Autoconcepto personal y moral a través del diálogo sobre la naturaleza humana.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },{ id: "1.2", text: "1.2 Expresión y gestión empática de emociones, ideas y relaciones.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },{ id: "1.3", text: "1.3 Autonomía moral mediante la deliberación ética y el diálogo respetuoso.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },{ id: "2.1", text: "2.1 Convivencia democrática y crítica a partir de conceptos sociales y políticos.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },{ id: "2.2", text: "2.2 Ciudadanía activa mediante la participación asociativa y decisiones colectivas.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },{ id: "2.3", text: "2.3 Compromiso ético frente a desigualdad, pobreza y límites de la ciencia.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },{ id: "2.4", text: "2.4 Igualdad de género y respeto a derechos LGTBIQ+ frente a discriminación.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },{ id: "2.5", text: "2.5 Defensa de los derechos humanos y respeto por la diversidad y los bienes comunes.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },{ id: "2.6", text: "2.6 Compromiso con la paz, la democracia y la solidaridad internacional.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },{ id: "3.1", text: "3.1 Interdependencia entre vida humana y entorno ante los problemas ecosociales.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },{ id: "3.2", text: "3.2 Debate crítico sobre respuestas científicas, políticas y éticas a la crisis climática.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },{ id: "3.3", text: "3.3 Estilos de vida sostenibles y responsables con personas, animales y medio ambiente.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },{ id: "4.1", text: "4.1 Gestión equilibrada de emociones y cuidado mutuo en contextos éticos y creativos.", cesp: "CESP4", descriptores: ["CCL1", "CPSAA1", "CPSAA2", "CPSAA3", "CC1", "CC3", "CCEC3"], claves: ["CCL", "CPSAA", "CC", "CCEC"] }],
        duaData: { principle1: { title: "I. Proporcionar múltiples medios de representación", guidelines: [{ id: 'p1-7.1', text: '7.1 Ofrecer opciones para atraer la atención.' },{ id: 'p1-7.2', text: '7.2 Optimizar la relevancia, el valor y la autenticidad.' },{ id: 'p1-7.3', text: '7.3 Minimizar la amenaza y la distracción.' },{ id: 'p1-8.1', text: '8.1 Proporcionar metas de aprendizaje claras y con andamiaje.' },{ id: 'p1-8.2', text: '8.2 Utilizar la colaboración y la comunidad como apoyo.' },{ id: 'p1-8.3', text: '8.3 Aumentar el feedback orientado al dominio y la perseverancia.' },{ id: 'p1-9.1', text: '9.1 Promover expectativas y creencias que optimicen la motivación.' },{ id: 'p1-9.2', text: '9.2 Facilitar estrategias para afrontar retos y gestionar emociones.' },{ id: 'p1-9.3', text: '9.3 Desarrollar la autoevaluación y la reflexión personal.' }] }, principle2: { title: "II. Proporcionar múltiples medios de acción y expresión", guidelines: [{ id: 'p2-1.1', text: '1.1 Ofrecer modos alternativos de presentar la información.' },{ id: 'p2-1.2', text: '1.2 Ofrecer alternativas para la información auditiva.' },{ id: 'p2-1.3', text: '1.3 Ofrecer alternativas para la información visual.' },{ id: 'p2-2.1', text: '2.1 Aclarar vocabulario y símbolos.' },{ id: 'p2-2.2', text: '2.2 Aclarar la sintaxis y la estructura.' },{ id: 'p2-2.3', text: '2.3 Apoyar la decodificación de textos, notación matemática y símbolos.' },{ id: 'p2-2.4', text: '2.4 Promover la comprensión de los diferentes idiomas.' },{ id: 'p2-2.5', text: '2.5 Ilustrar a través de múltiples medios.' },{ id: 'p2-3.1', text: '3.1 Activar o aportar conocimientos previos.' },{ id: 'p2-3.2', text: '3.2 Destacar patrones, características y relaciones clave.' },{ id: 'p2-3.3', text: '3.3 Guiar el procesamiento de la información y la visualización.' },{ id: 'p2-3.4', text: '3.4 Maximizar la transferencia y la generalización.' }] }, principle3: { title: "III. Proporcionar múltiples formas de implicación", guidelines: [{ id: 'p3-4.1', text: '4.1 Variedad de métodos de respuesta y navegación.' },{ id: 'p3-4.2', text: '4.2 Acceso optimizado a herramientas y tecnologías.' },{ id: 'p3-5.1', text: '5.1 Múltiples medios para la comunicación.' },{ id: 'p3-5.2', text: '5.2 Múltiples herramientas para la construcción y composición.' },{ id: 'p3-5.3', text: '5.3 Apoyos para la fluidez con diferentes medios de comunicación.' },{ id: 'p3-6.1', text: '6.1 Guiar la definición de metas adecuadas.' },{ id: 'p3-6.2', text: '6.2 Apoyar la planificación y el desarrollo de estrategias.' },{ id: 'p3-6.3', text: '6.3 Facilitar la gestión de la información y de recursos.' },{ id: 'p3-6.4', text: '6.4 Promover la monitorización del progreso.' }] } },
        appData: { materias: ["Filosofía","Hª de la Filosofía","Valores Éticos","Psicología"], cursos: ["1º ESO","2º ESO","3º ESO","4º ESO","1º Bachillerato","2º Bachillerato"], sesiones: Array.from({length:15},(_,i)=>`Sesión ${i+1}`), tiposEvaluacion: ["Formativa", "Competencial", "Sumativa", "Heteroevaluación", "Autoevaluación", "Coevaluación"], unidadesDidacticas: Array.from({length:15},(_,i)=>`Unidad ${i+1}`) },
        allEditorIds: ['situacionAprendizaje', 'contenidosTransversales', 'contextoReto', 'contenidos', 'metodologias', 'resultadosEsperados', 'preparacionPrevia', 'actividad1', 'actividad2', 'actividad3', 'actividad4', 'instrumentosEvaluacion', 'recursos', 'observaciones', 'adaptacion', 'criteriosCalificacion']
    };
    const state = { currentSessionId: null, currentStep: 1, maxStepReached: 1, currentDuaPrincipleKey: null, allSessions: [], autoSaveTimer: null, editors: {}, currentMultiSelect: null, calendar: null, resourceBank: { activities: [], instruments: [] }, bankModalTarget: { type: null, editorId: null } };
    const api = { async call(action, data = {}) { const res = await fetch(config.SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=UTF-8' }, body: JSON.stringify({ action, ...data }) }); if (!res.ok) throw new Error(`Error de red: ${res.status} ${res.statusText}`); const text = await res.text(); let result; try { result = JSON.parse(text); } catch { throw new Error(`Respuesta no JSON del servidor: ${text.slice(0, 200)}`); } if (!result.success) throw new Error(result.message || 'Error desconocido en el servidor'); return result.data; } };
    const bank = { load() { const data = localStorage.getItem('resourceBank'); if (data) { state.resourceBank = JSON.parse(data); } }, save() { localStorage.setItem('resourceBank', JSON.stringify(state.resourceBank)); }, addItem(type, title, content) { const item = { id: `res_${Date.now()}`, title, content, createdAt: new Date().toISOString() }; state.resourceBank[type].push(item); bank.save(); }, deleteItem(type, id) { state.resourceBank[type] = state.resourceBank[type].filter(item => item.id !== id); bank.save(); } };
    const calendar = { generateICS(session) { if (!session || !session.fecha) return null; const formatDate = (dateStr) => { const date = new Date(dateStr); const year = date.getUTCFullYear(); const month = (date.getUTCMonth() + 1).toString().padStart(2, '0'); const day = date.getUTCDate().toString().padStart(2, '0'); return `${year}${month}${day}`; }; const formatText = (text) => (text || '').replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n'); const tempDiv = document.createElement('div'); tempDiv.innerHTML = session.situacionAprendizaje || ''; const title = formatText(tempDiv.textContent.split('\n')[0] || 'Sesión sin título'); const startDate = formatDate(session.fecha); let description = `Materia(s): ${formatText((session.materia || []).join(', '))}\\n`; description += `Curso(s): ${formatText((session.curso || []).join(', '))}\\n\\n`; description += '--- CONTEXTO ---\\n'; tempDiv.innerHTML = session.contextoReto || 'No especificado.'; description += formatText(tempDiv.textContent); const uid = `${startDate}-${session.id.slice(0, 8)}@planificador.app`; const timestamp = new Date().toISOString().replace(/-|:|\.\d+/g, ''); return [ 'BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//PlanificadorDidactico//ES', 'BEGIN:VEVENT', `UID:${uid}`, `DTSTAMP:${timestamp}`, `DTSTART;VALUE=DATE:${startDate}`, `DTEND;VALUE=DATE:${startDate}`, `SUMMARY:${title}`, `DESCRIPTION:${description}`, 'END:VEVENT', 'END:VCALENDAR' ].join('\r\n'); } };
    const ui = {
        showModal(title, text, options = {}) { const { showSpinner = false, buttons = [{ text: 'OK', class: 'bg-blue-500', callback: ui.hideModal }] } = options; document.getElementById('modal-title').textContent = title; document.getElementById('modal-text').innerHTML = text; document.getElementById('modal-spinner').style.display = showSpinner ? 'block' : 'none'; const buttonsContainer = document.getElementById('modal-buttons'); buttonsContainer.innerHTML = ''; buttons.forEach(info => { const b = document.createElement('button'); b.textContent = info.text; b.className = `text-white font-bold py-2 px-4 rounded-lg transition-colors ${info.class}`; b.addEventListener('click', () => { ui.hideModal(); if (info.callback) info.callback(); }); buttonsContainer.appendChild(b); }); document.getElementById('modal').classList.remove('hidden'); },
        hideModal() { document.getElementById('modal').classList.add('hidden'); },
        prompt(title, text, callback) { const inputId = 'prompt-input'; ui.showModal(title, `<p class="py-2 text-slate-600">${text}</p><input id="${inputId}" type="text" class="w-full p-2 border border-slate-300 rounded-md shadow-sm" placeholder="Escribe un título descriptivo...">`, { buttons: [ { text: 'Cancelar', class: 'bg-slate-500' }, { text: 'Guardar', class: 'bg-blue-500', callback: () => { const value = document.getElementById(inputId).value; callback(value); }}] }); document.getElementById(inputId).focus(); },
        showDuaModal(principleKey) { state.currentDuaPrincipleKey = principleKey; const principle = config.duaData[principleKey]; document.getElementById('dua-modal-title').textContent = principle.title; const content = document.getElementById('dua-modal-content'); content.innerHTML = ''; const saved = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]'); principle.guidelines.forEach(g => { const row = document.createElement('div'); row.className = 'flex items-center'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `dua-guideline-${g.id}`; cb.value = g.text; cb.checked = saved.includes(g.text); cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500'; const label = document.createElement('label'); label.htmlFor = cb.id; label.textContent = g.text; label.className = 'ml-3 text-sm text-slate-600'; row.appendChild(cb); row.appendChild(label); content.appendChild(row); }); document.getElementById('dua-modal').classList.remove('hidden'); },
        hideDuaModal() { state.currentDuaPrincipleKey = null; document.getElementById('dua-modal').classList.add('hidden'); },
        showMultiSelectModal(type) { state.currentMultiSelect = type; const modal = document.getElementById('multi-select-modal'); const titleEl = document.getElementById('multi-select-modal-title'); const contentEl = document.getElementById('multi-select-modal-content'); contentEl.innerHTML = ''; let title = ''; let options = []; if (type === 'materia') { title = 'Seleccionar Materia(s)'; options = config.appData.materias; } else if (type === 'curso') { title = 'Seleccionar Curso(s)'; options = config.appData.cursos; } else if (type === 'sesionNum') { title = 'Seleccionar Sesión(es)'; options = config.appData.sesiones; } else if (type === 'tiposEvaluacion') { title = 'Seleccionar Tipos de Evaluación'; options = config.appData.tiposEvaluacion; } else if (type === 'contenidosTransversales') { title = 'Seleccionar Contenidos Transversales'; options = config.appData.contenidosTransversales; } else if (type === 'unidadDidactica') { title = 'Seleccionar Unidad(es) Didáctica(s)'; options = config.appData.unidadesDidacticas; } titleEl.textContent = title; const currentValues = JSON.parse(document.getElementById(type).value || '[]'); options.forEach(opt => { const wrapper = document.createElement('div'); const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `ms-${type}-${opt.substring(0, 20)}`; cb.value = opt; cb.checked = currentValues.includes(opt); cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500'; const label = document.createElement('label'); label.htmlFor = cb.id; label.textContent = opt; label.className = 'ml-2 text-sm text-slate-600'; wrapper.appendChild(cb); wrapper.appendChild(label); contentEl.appendChild(wrapper); }); modal.classList.remove('hidden'); },
        hideMultiSelectModal() { state.currentMultiSelect = null; document.getElementById('multi-select-modal').classList.add('hidden'); },
        showBankModal(type, editorId) {
            state.bankModalTarget = { type, editorId };
            const modal = document.getElementById('bank-modal');
            const titleEl = document.getElementById('bank-modal-title');
            const contentEl = document.getElementById('bank-modal-content');
            const typeText = type === 'activities' ? 'Actividades' : 'Instrumentos';
            titleEl.textContent = `Banco de ${typeText}`;
            const renderItems = () => {
                contentEl.innerHTML = '';
                const items = state.resourceBank[type];
                if (items.length === 0) { contentEl.innerHTML = `<div class="text-center p-8 border border-dashed rounded-lg text-slate-500">No hay ${typeText.toLowerCase()} en tu banco. Usa el botón "Guardar en Banco" para añadir.</div>`; return; }
                items.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(item => {
                    const itemEl = document.createElement('div'); itemEl.className = 'p-3 border rounded-md mb-3 flex justify-between items-center';
                    itemEl.innerHTML = `<div class="truncate pr-4"><strong class="text-slate-700">${item.title}</strong></div>`;
                    const buttonsWrapper = document.createElement('div'); buttonsWrapper.className = 'flex gap-2 flex-shrink-0';
                    const useBtn = document.createElement('button'); useBtn.textContent = 'Usar'; useBtn.className = 'bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors';
                    useBtn.addEventListener('click', () => { state.editors[editorId].setContents(item.content); ui.hideBankModal(); });
                    const deleteBtn = document.createElement('button'); deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>'; deleteBtn.className = 'bg-red-100 hover:bg-red-200 text-red-600 font-bold p-2 rounded-lg transition-colors';
                    deleteBtn.addEventListener('click', () => { ui.showModal('Confirmar borrado', `¿Seguro que quieres borrar "<b>${item.title}</b>"? Esta acción no se puede deshacer.`, { buttons: [{ text: 'Cancelar', class: 'bg-slate-500' }, { text: 'Sí, Borrar', class: 'bg-red-500', callback: () => { bank.deleteItem(type, item.id); renderItems(); }}] }); });
                    buttonsWrapper.appendChild(useBtn); buttonsWrapper.appendChild(deleteBtn); itemEl.appendChild(buttonsWrapper); contentEl.appendChild(itemEl);
                });
            };
            renderItems(); modal.classList.remove('hidden');
        },
        hideBankModal() { document.getElementById('bank-modal').classList.add('hidden'); },
        updateChipsDisplay(fieldId, values) { const displayEl = document.getElementById(`${fieldId}-display`); if (!displayEl) return; displayEl.innerHTML = ''; if (values && values.length > 0) { values.forEach(value => { const chip = document.createElement('span'); chip.className = 'inline-block text-xs bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5 mr-1 mb-1'; chip.textContent = value; displayEl.appendChild(chip); }); } else { displayEl.innerHTML = '<span class="text-slate-400">No seleccionado</span>'; } },
        showSearchModal() { const populateSelect = (selectId, data) => { const select = document.getElementById(selectId); select.innerHTML = ''; data.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; select.appendChild(o); }); }; populateSelect('search-materia', config.appData.materias); populateSelect('search-curso', config.appData.cursos); populateSelect('search-sesion', config.appData.sesiones); document.getElementById('search-modal').classList.remove('hidden'); },
        hideSearchModal() { document.getElementById('search-modal').classList.add('hidden'); },
        createFormField(id, label, type, options = []) { const hasBank = ['actividad1', 'actividad2', 'actividad3', 'actividad4', 'instrumentosEvaluacion'].includes(id); const bankType = id.startsWith('actividad') ? 'activities' : 'instruments'; const wrapper = document.createElement('div'); const labelWrapper = document.createElement('div'); labelWrapper.className = 'flex justify-between items-center mb-1'; const labelEl = document.createElement('label'); labelEl.setAttribute('for', id); labelEl.className = 'block text-sm font-medium text-slate-700'; labelEl.textContent = label; labelWrapper.appendChild(labelEl); if (hasBank) { const bankButtons = document.createElement('div'); bankButtons.className = 'flex gap-3'; bankButtons.innerHTML = `<button type="button" class="js-bank-import text-xs font-semibold text-indigo-600 hover:underline" data-type="${bankType}" data-editor="${id}">Importar</button><button type="button" class="js-bank-save text-xs font-semibold text-green-600 hover:underline" data-type="${bankType}" data-editor="${id}">Guardar en Banco</button>`; labelWrapper.appendChild(bankButtons); } wrapper.appendChild(labelWrapper); let field; if (type === 'textarea') { field = document.createElement('textarea'); field.className = 'hidden'; wrapper.appendChild(field); } else if (type === 'date') { field = document.createElement('input'); field.type = 'date'; field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500'; wrapper.appendChild(field); } else if (type === 'readonly-textarea') { field = document.createElement('textarea'); field.rows = 3; field.readOnly = true; field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm bg-slate-100 focus:ring-0 focus:border-slate-300 cursor-not-allowed'; wrapper.appendChild(field); } else if (type === 'checkbox-group') { field = document.createElement('div'); field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm overflow-y-auto checkbox-group'; options.forEach(opt => { const row = document.createElement('div'); row.className = 'flex items-start my-2'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `${id}-${opt.id}`; cb.name = id; cb.value = opt.text; cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-1 flex-shrink-0'; const lab = document.createElement('label'); lab.htmlFor = cb.id; lab.textContent = opt.text; lab.className = 'ml-3 text-sm text-slate-600'; row.appendChild(cb); row.appendChild(lab); field.appendChild(row); }); wrapper.appendChild(field); } else if (type === 'dua-group') { field = document.createElement('div'); field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm space-y-3'; const hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.id = 'selectedDuaGuidelines'; field.appendChild(hidden); Object.entries(config.duaData).forEach(([key, value]) => { const item = document.createElement('div'); item.className = 'flex items-center justify-between'; const left = document.createElement('div'); left.className = 'flex items-center'; const cb = document.createElement('input'); cb.type = 'checkbox'; cb.id = `dua-${key}`; cb.name = 'dua'; cb.value = value.title; cb.className = 'h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500'; const lab = document.createElement('label'); lab.htmlFor = cb.id; lab.textContent = value.title; lab.className = 'ml-3 text-sm text-slate-600'; left.appendChild(cb); left.appendChild(lab); item.appendChild(left); if (value.guidelines.length) { const btn = document.createElement('button'); btn.type = 'button'; btn.textContent = 'Seleccionar Pautas'; btn.className = 'text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-lg transition-colors'; btn.addEventListener('click', () => ui.showDuaModal(key)); item.appendChild(btn); } field.appendChild(item); }); wrapper.appendChild(field); } if (field) { field.id = id; if (type !== 'checkbox-group' && type !== 'dua-group') { field.name = id; } } return wrapper; },
        ensureEditorsInitialized(ids) { ids.forEach(id => { const textarea = document.getElementById(id); if (textarea && !state.editors[id]) { state.editors[id] = SUNEDITOR.create(id, { buttonList: [['undo', 'redo'], ['bold', 'italic', 'underline'], ['list']], height: 'auto', minHeight: '100px', callbacks: { onChange: app.triggerAutoSave } }); } }); },
        destroyEditors() { Object.values(state.editors).forEach(editor => { if (editor && typeof editor.destroy === 'function') { editor.destroy(); } }); state.editors = {}; },
        updateDerivedFields() { const selected = Array.from(document.querySelectorAll('input[name="criteriosEvaluacion"]:checked')).map(cb => cb.value); const allCesp = new Set(), allDes = new Set(), allClaves = new Set(); config.evaluationData.forEach(c => { if (selected.includes(c.text)) { allCesp.add(c.cesp); c.descriptores.forEach(d => allDes.add(d)); c.claves.forEach(k => allClaves.add(k)); } }); document.getElementById('competenciaEspecifica').value = [...allCesp].join(', '); document.getElementById('descriptoresOperativos').value = [...allDes].join(', '); document.getElementById('competenciasClave').value = [...allClaves].join(', '); },
        updateStepNavigator() { const { currentStep, maxStepReached } = state; const steps = document.querySelectorAll('#step-navigator .step-item'); steps.forEach(stepEl => { const stepNumber = parseInt(stepEl.dataset.step); const iconEl = stepEl.querySelector('.step-icon'); stepEl.classList.remove('step-active', 'step-completed', 'step-disabled'); if (stepNumber < maxStepReached || (state.currentSessionId && maxStepReached === 5) ) { stepEl.classList.add('step-completed'); iconEl.innerHTML = '✓'; } else { iconEl.innerHTML = stepNumber; } if (stepNumber === currentStep) { stepEl.classList.add('step-active'); } else if (stepNumber > maxStepReached) { stepEl.classList.add('step-disabled'); } }); },
        renderInfoSummary() { const data = app.getFormData(); const tempDiv = document.createElement('div'); tempDiv.innerHTML = data.situacionAprendizaje || ''; const title = tempDiv.textContent.split('\n')[0] || 'Sesión sin título'; const materia = data.materia || []; const curso = data.curso || []; const sesionNum = data.sesionNum || []; const fecha = data.fecha; const formattedDate = fecha ? new Date(fecha).toLocaleDateString('es-ES', { timeZone: 'UTC' }) : '<span class="text-slate-400">Sin fecha</span>'; const currentStepContainer = document.getElementById(`form-step-${state.currentStep}`); let summary = currentStepContainer.querySelector('.info-summary'); if (!summary) { summary = document.createElement('div'); summary.className = 'info-summary mb-4'; currentStepContainer.prepend(summary); } summary.innerHTML = `<div class="border border-slate-200 rounded-lg p-4 bg-slate-50"><h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Información general</h3><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mt-2"><div class="lg:col-span-2"><div class="text-xs uppercase text-slate-500">Título</div><div class="text-sm text-slate-800">${title || '<span class="text-slate-400">Sin título</span>'}</div></div><div><div class="text-xs uppercase text-slate-500">Materia(s)</div><div>${ui.chipsHtml(materia)}</div></div><div><div class="text-xs uppercase text-slate-500">Curso(s)</div><div>${ui.chipsHtml(curso)}</div></div><div><div class="text-xs uppercase text-slate-500">Sesión(es)</div><div>${ui.chipsHtml(sesionNum)}</div></div><div><div class="text-xs uppercase text-slate-500">Fecha</div><div class="text-sm text-slate-800">${formattedDate}</div></div></div></div>`; summary.classList.remove('hidden'); },
        chipsHtml(arr) { const a = Array.isArray(arr) ? arr : []; return a.length ? a.map(v => `<span class="inline-block text-xs bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5 mr-1 mb-1">${String(v)}</span>`).join('') : '<span class="text-slate-400 text-sm">Sin seleccionar</span>'; },
        buildForm() { ui.destroyEditors(); const form = document.getElementById('session-form'); form.innerHTML = ''; const step1 = document.createElement('div'); step1.id = 'form-step-1'; step1.className = 'space-y-6'; const step2 = document.createElement('div'); step2.id = 'form-step-2'; step2.className = 'hidden space-y-6'; const step3 = document.createElement('div'); step3.id = 'form-step-3'; step3.className = 'hidden space-y-6'; const step4 = document.createElement('div'); step4.id = 'form-step-4'; step4.className = 'hidden space-y-6'; const step5 = document.createElement('div'); step5.id = 'form-step-5'; step5.className = 'hidden space-y-6'; const fieldsets = [{ step:1, legend: 'Información General', fields:[ { id:'situacionAprendizaje', label:'Sesión de Aprendizaje', type:'textarea' }, { id:'unidadDidactica', label:'Unidad Didáctica', type:'modal-multiselect' }, { id:'fecha', label:'Fecha', type:'date' }, { id:'materia', label:'Materia', type:'modal-multiselect' }, { id:'curso', label:'Curso', type:'modal-multiselect' }, { id:'sesionNum', label:'Nº de la Sesión', type:'modal-multiselect' }, ]},{ step:2, legend: 'Detalles de la Sesión', fields:[ { id:'contextoReto', label:'Contexto-reto', type:'textarea' }, { id:'contenidos', label:'Contenidos', type:'textarea' }, { id:'metodologias', label:'Metodologías', type:'textarea' }, { id:'resultadosEsperados', label:'Resultados esperados al final de la sesión', type:'textarea' }, { id:'preparacionPrevia', label:'Preparación previa', type:'textarea' }, ]},{ step:3, legend: 'Actividades', fields:[ { id:'actividad1', label:'Actividad 1', type:'textarea' }, { id:'actividad2', label:'Actividad 2', type:'textarea' }, { id:'actividad3', label:'Actividad 3', type:'textarea' }, { id:'actividad4', label:'Actividad 4', type:'textarea' }, ]},{ step:4, legend: 'Evaluación', fields:[ { id:'criteriosEvaluacion', label:'Criterios de Evaluación', type:'checkbox-group', options: config.evaluationData }, { id:'instrumentosEvaluacion', label:'Instrumentos de Evaluación', type:'textarea' }, { id:'tiposEvaluacion', label:'Tipos de Evaluación', type:'modal-multiselect' }, { id:'criteriosCalificacion', label:'Criterios de Calificación', type:'textarea' }, { id:'recursos', label:'Recursos', type:'textarea' }, ]},{ step:5, legend: 'Marco Pedagógico (Automático)', fields:[ { id:'competenciaEspecifica', label:'Competencia Específica', type:'readonly-textarea' }, { id:'descriptoresOperativos', label:'Descriptores Operativos', type:'readonly-textarea' }, { id:'competenciasClave', label:'Competencias Clave', type:'readonly-textarea' }, { id:'contenidosTransversales', label:'Contenidos Transversales', type:'textarea' }, ]},{ step:5, legend: 'Atención a la Diversidad', fields:[ { id:'dua', label:'DUA', type:'dua-group' }, { id:'adaptacion', label:'Adaptación', type:'textarea' }, ]},{ step:5, legend: 'Observaciones', fields:[ { id:'observaciones', label:'Observaciones y notas adicionales', type:'textarea' }, ]},]; fieldsets.forEach(fs => { const fsEl = document.createElement('fieldset'); fsEl.className = 'border border-slate-200 p-4 rounded-lg'; const legend = document.createElement('legend'); legend.className = 'text-md font-semibold px-2 text-slate-600'; legend.textContent = fs.legend; fsEl.appendChild(legend); const grid = document.createElement('div'); grid.className = fs.fields.length > 2 ? 'grid grid-cols-1 md:grid-cols-2 gap-4' : 'grid grid-cols-1 gap-4'; fs.fields.forEach(f => { let fieldWrapper; if (f.type === 'modal-multiselect') { fieldWrapper = document.createElement('div'); fieldWrapper.innerHTML = `<label class="block text-sm font-medium text-slate-700 mb-1">${f.label}</label><div class="flex items-center gap-4"><div id="${f.id}-display" class="w-full p-2 border border-slate-300 rounded-md bg-slate-50 min-h-[40px] flex items-center flex-wrap"><span class="text-slate-400">No seleccionado</span></div><input type="hidden" id="${f.id}" name="${f.id}" value="[]"><button type="button" data-modal-trigger="${f.id}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex-shrink-0">Seleccionar</button></div>`; } else { fieldWrapper = ui.createFormField(f.id, f.label, f.type, f.options); } if (['situacionAprendizaje', 'recursos', 'criteriosCalificacion'].includes(f.id)) { fieldWrapper.classList.add('md:col-span-2'); } grid.appendChild(fieldWrapper); }); fsEl.appendChild(grid); if(fs.step === 1) step1.appendChild(fsEl); if(fs.step === 2) step2.appendChild(fsEl); if(fs.step === 3) step3.appendChild(fsEl); if(fs.step === 4) step4.appendChild(fsEl); if(fs.step === 5) step5.appendChild(fsEl); }); const createNavButtons = (backStep, nextStep) => { const nav = document.createElement('div'); nav.className = 'flex justify-between mt-6'; if (backStep) { const backBtn = document.createElement('button'); backBtn.type = 'button'; backBtn.textContent = 'Atrás'; backBtn.className = 'bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors'; backBtn.addEventListener('click', () => app.navigateToStep(backStep)); nav.appendChild(backBtn); } else { nav.appendChild(document.createElement('div')); } if (nextStep) { const continueBtn = document.createElement('button'); continueBtn.type = 'button'; continueBtn.textContent = 'Continuar'; continueBtn.className = 'bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors'; continueBtn.addEventListener('click', () => app.navigateToStep(nextStep)); nav.appendChild(continueBtn); } return nav; }; step1.appendChild(createNavButtons(null, 2)); step2.appendChild(createNavButtons(1, 3)); step3.appendChild(createNavButtons(2, 4)); step4.appendChild(createNavButtons(3, 5)); step5.appendChild(createNavButtons(4, null)); form.appendChild(step1); form.appendChild(step2); form.appendChild(step3); form.appendChild(step4); form.appendChild(step5); form.addEventListener('change', (e) => { if (e.target.name === 'criteriosEvaluacion') ui.updateDerivedFields(); app.triggerAutoSave(); }); },
        renderSessionList(sessionsToRender = state.allSessions) { const sessionList = document.getElementById('session-list'); const template = document.getElementById('template-session-item'); sessionList.innerHTML = ''; if (!sessionsToRender.length) { sessionList.innerHTML = '<p class="text-center text-slate-500 p-4">No se encontraron sesiones.</p>'; return; } sessionsToRender.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); sessionsToRender.forEach(session => { const clone = template.content.cloneNode(true); const div = clone.querySelector('div'); const tempDiv = document.createElement('div'); tempDiv.innerHTML = session.situacionAprendizaje || ''; const title = tempDiv.textContent.split('\n')[0] || 'Sin título'; const subtitle = `${session.materia?.[0] || 'Sin materia'} - ${session.curso?.[0] || 'Sin curso'}`; div.dataset.id = session.id; div.classList.toggle('bg-blue-100', state.currentSessionId === session.id); div.classList.toggle('border-blue-500', state.currentSessionId === session.id); clone.querySelector('[data-template="title"]').textContent = title; clone.querySelector('[data-template="subtitle"]').textContent = subtitle; div.addEventListener('click', () => app.displaySession(session.id)); sessionList.appendChild(clone); }); },
        populateForm(data) { const form = document.getElementById('session-form'); form.reset(); const parseArrayData = (value) => { if (Array.isArray(value)) return value; if (typeof value !== 'string' || !value) return []; if (value.startsWith('[') && value.endsWith(']')) { try { return JSON.parse(value); } catch (e) { /* fall through */ } } return value.split(','); }; for (const key in data) { if (['materia', 'curso', 'sesionNum', 'tiposEvaluacion', 'contenidosTransversales', 'unidadDidactica'].includes(key)) { const values = parseArrayData(data[key]); document.getElementById(key).value = JSON.stringify(values); ui.updateChipsDisplay(key, values); } else if (state.editors[key]) { let content = data[key] || ''; if (Array.isArray(content)) { content = content.join('<br>'); } state.editors[key].setContents(String(content)); } else { const field = form.elements[key]; if (field) { if (key === 'fecha' && data[key]) { field.value = new Date(data[key]).toISOString().split('T')[0]; } else { field.value = data[key] || ''; } } else if (key === 'criteriosEvaluacion' || key === 'dua') { const saved = parseArrayData(data[key]); document.querySelectorAll(`input[name="${key}"]`).forEach(cb => { cb.checked = saved.includes(cb.value); }); } } } document.getElementById('selectedDuaGuidelines').value = JSON.stringify(parseArrayData(data.duaGuidelines)); ui.updateDerivedFields(); },
        printReport() { if (!state.currentSessionId) { ui.showModal('Aviso', 'Por favor, guarda la sesión antes de imprimir.'); return; } const data = state.allSessions.find(s => s.id === state.currentSessionId); if (!data) return; const printArea = document.getElementById('print-area'); const createIcon = (path) => `<svg class="w-6 h-6 mr-3 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${path}</svg>`; const icons = { situacion: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'), actividades: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.085a2 2 0 00-1.736.97l-1.9 3.8a2 2 0 00.23 2.16l3.5 3.5m7-10L7 5"></path>'), evaluacion: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'), marco: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h1a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 16.95l.826.826m8.334-8.334l.826.826m-1.06-7.553l.267.267m-1.623 1.623l.267.267M16.95 7.737l.826.826M12 21a9 9 0 100-18 9 9 0 000 18z"></path>'), diversidad: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>'), info: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>'), observaciones: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.586a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>') }; const createList = (items) => !items || items.length === 0 ? '<p class="text-slate-500 italic mt-2">No especificado</p>' : `<ul class="list-disc list-inside space-y-1 mt-2 pl-2">${items.map(i => `<li>${i}</li>`).join('')}</ul>`; const createText = (content) => { const strContent = String(content || ''); return !strContent || strContent.trim() === '' || strContent.trim() === '<p><br></p>' ? '<p class="text-slate-500 italic mt-2">No especificado</p>' : `<div class="prose prose-sm max-w-none mt-2">${strContent}</div>`; }; const createCard = (templateId, title, icon, content) => { const template = document.getElementById(templateId); if (!template) return ''; const clone = template.content.cloneNode(true); clone.querySelector('[data-template="title"]').textContent = title; clone.querySelector('[data-template="icon-container"]').innerHTML = icon; clone.querySelector('[data-template="content"]').innerHTML = content; return clone.firstElementChild.outerHTML; }; const tempDiv = document.createElement('div'); tempDiv.innerHTML = data.situacionAprendizaje || ''; const situacionTitle = tempDiv.textContent.split('\n')[0] || 'Situación de Aprendizaje sin Título'; const situacionBody = data.situacionAprendizaje || ''; const actividadesContent = [data.actividad1, data.actividad2, data.actividad3, data.actividad4].map((act, i) => act && act.trim() !== '<p><br></p>' ? `<div><strong class="font-semibold text-slate-700">Actividad ${i + 1}:</strong>${createText(act)}</div>` : '').filter(Boolean).join('<hr class="my-4 border-slate-200">'); const evaluacionContent = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><strong class="font-semibold text-slate-700">Criterios de Evaluación:</strong>${createList(data.criteriosEvaluacion)}</div><div><strong class="font-semibold text-slate-700">Instrumentos:</strong>${createText(data.instrumentosEvaluacion)}</div><div><strong class="font-semibold text-slate-700">Tipos de Evaluación:</strong>${createList(data.tiposEvaluacion)}</div><div><strong class="font-semibold text-slate-700">Criterios de Calificación:</strong>${createText(data.criteriosCalificacion)}</div><div class="md:col-span-2"><strong class="font-semibold text-slate-700">Recursos:</strong>${createText(data.recursos)}</div></div>`; const marcoContent = `<strong class="font-semibold text-slate-700">Competencia Específica:</strong>${createText(data.competenciaEspecifica)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Descriptores Operativos:</strong>${createText(data.descriptoresOperativos)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Competencias Clave:</strong>${createText(data.competenciasClave)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Contenidos Transversales:</strong>${createText(data.contenidosTransversales)}`; const duaGuidelines = data.duaGuidelines && data.duaGuidelines.length ? `<div><strong class="font-semibold text-slate-700 mt-4 block">Pautas Específicas:</strong>${createList(data.duaGuidelines)}</div>` : ''; const diversidadContent = `<strong class="font-semibold text-slate-700">Principios DUA:</strong>${createList(data.dua)}${duaGuidelines}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Adaptaciones:</strong>${createText(data.adaptacion)}`; const observacionesContent = data.observaciones && data.observaciones.trim() !== '' ? createText(data.observaciones) : `<div class="h-48"></div>`; const fecha = data.fecha ? new Date(data.fecha).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }) : 'No especificada'; const infoGeneralContent = `<strong class="font-semibold text-slate-700">Fecha:</strong><p class="mt-1 mb-3 pl-2">${fecha}</p><strong class="font-semibold text-slate-700">Materia(s):</strong>${createList(data.materia)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Curso(s):</strong>${createList(data.curso)}<hr class="my-3 border-slate-200"><strong class="font-semibold text-slate-700">Sesión(es):</strong>${createList(data.sesionNum)}`; printArea.innerHTML = `<div class="p-8 bg-slate-50 font-sans"><header class="text-center mb-10"><h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">Programación de Sesión</h1><p class="mt-2 text-lg text-slate-500">Informe Detallado</p></header>${createCard('template-print-card', 'Sesión de Aprendizaje', icons.situacion, `<h2 class="text-2xl font-bold text-indigo-700">${situacionTitle}</h2><div class="prose prose-slate max-w-none mt-4">${situacionBody}</div>`)}<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">${createCard('template-print-sidebar-card','Información General', icons.info, infoGeneralContent)}${createCard('template-print-sidebar-card','Marco Pedagógico', icons.marco, marcoContent)}</div>${createCard('template-print-card', 'Secuencia de Actividades', icons.actividades, actividadesContent || createText(null))}<div class="mt-2">${createCard('template-print-card','Estrategia de Evaluación', icons.evaluacion, evaluacionContent)}${createCard('template-print-card','Atención a la Diversidad', icons.diversidad, diversidadContent)}${createCard('template-print-card','Observaciones', icons.observaciones, observacionesContent)}</div><footer class="text-center mt-10 pt-6 border-t border-slate-200"><p class="text-sm text-slate-500">Informe generado con el Planificador Didáctico - ${new Date().toLocaleDateString('es-ES')}</p></footer></div>`; window.print(); },
        renderDashboard() { const sessions = [...state.allSessions]; sessions.sort((a, b) => new Date(b.updatedAt || b.createdAt) - new Date(a.createdAt)); const recentContainer = document.getElementById('recent-sessions-container'); recentContainer.innerHTML = ''; if (sessions.length > 0) { sessions.slice(0, 3).forEach(session => { const tempDiv = document.createElement('div'); tempDiv.innerHTML = session.situacionAprendizaje || ''; const title = tempDiv.textContent.split('\n')[0] || 'Sin título'; const subtitle = `${session.materia?.[0] || 'Sin materia'} - ${session.curso?.[0] || 'Sin curso'}`; const date = session.fecha ? new Date(session.fecha).toLocaleDateString('es-ES', {day: '2-digit', month: 'short', timeZone: 'UTC'}) : 'Sin fecha'; const card = document.createElement('div'); card.className = 'p-4 border border-slate-200 rounded-lg hover:bg-slate-50 hover:shadow-sm cursor-pointer transition-all'; card.dataset.id = session.id; card.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="font-semibold text-slate-800 truncate">${title}</h4><p class="text-sm text-slate-500">${subtitle}</p></div><span class="text-xs font-medium bg-slate-100 text-slate-600 px-2 py-1 rounded-full">${date}</span></div>`; card.addEventListener('click', () => app.displaySession(session.id)); recentContainer.appendChild(card); }); } else { recentContainer.innerHTML = '<p class="text-slate-500 text-center p-4 border border-dashed rounded-lg">Aún no has creado ninguna sesión. ¡Empieza ahora!</p>'; } const calendarContainer = document.getElementById('calendar-container'); calendarContainer.innerHTML = ''; const markedDays = state.allSessions.filter(s => s.fecha).map(s => new Date(s.fecha).toISOString().split('T')[0]); state.calendar = new VanillaJsCalendar(calendarContainer, { settings: { lang: 'es', iso8601: true, selection: { day: false }, visibility: { theme: 'light' }, markedDays: [...new Set(markedDays)] } }); state.calendar.init(); }
    };
    const app = {
        async loadSessions() { const sessionList = document.getElementById('session-list'); sessionList.innerHTML = '<div id="loading-sessions" class="p-4 text-center text-slate-500">Cargando sesiones...</div>'; try { state.allSessions = await api.call('getSessions'); ui.renderSessionList(); ui.renderDashboard(); } catch (error) { console.error('Error detallado al cargar sesiones:', error); const loadingEl = document.getElementById('loading-sessions'); if (loadingEl) { loadingEl.textContent = 'Error al cargar sesiones.'; } ui.showModal('Error de Conexión', `No se pudieron cargar las sesiones. Detalles: ${error.message}.`); } },
        navigateToStep(step) { if (step > state.maxStepReached) return; ui.ensureEditorsInitialized(config.allEditorIds); for (let i = 1; i <= 5; i++) { document.getElementById(`form-step-${i}`).classList.add('hidden'); } if (step > 1) { ui.renderInfoSummary(); } document.getElementById(`form-step-${step}`).classList.remove('hidden'); state.currentStep = step; if (step > state.maxStepReached) { state.maxStepReached = step; } document.getElementById('form-title').textContent = config.formStepTitles[step - 1]; ui.updateStepNavigator(); document.getElementById('form-container').scrollTop = 0; },
        displaySession(sessionId) { const sessionData = state.allSessions.find(s => s.id === sessionId); if (!sessionData) return; document.getElementById('welcome-message').classList.add('hidden'); document.getElementById('form-wrapper').classList.remove('hidden'); document.getElementById('action-buttons').classList.remove('hidden'); ui.ensureEditorsInitialized(config.allEditorIds); state.currentSessionId = sessionId; state.maxStepReached = 5; document.querySelectorAll('#session-list > div').forEach(div => { div.classList.toggle('bg-blue-100', div.dataset.id === state.currentSessionId); div.classList.toggle('border-blue-500', div.dataset.id === state.currentSessionId); }); document.getElementById('export-calendar-btn').disabled = !sessionData.fecha; const autoSavedDataRaw = localStorage.getItem(`autosave_${sessionId}`); if (autoSavedDataRaw) { const autoSavedData = JSON.parse(autoSavedDataRaw); ui.showModal('Restaurar Sesión', 'Se han encontrado datos autoguardados para esta sesión. ¿Quieres restaurarlos?', { buttons: [{ text: 'No, usar versión guardada', class: 'bg-slate-500', callback: () => { ui.populateForm(sessionData); app.navigateToStep(1); } }, { text: 'Sí, restaurar', class: 'bg-blue-500', callback: () => { ui.populateForm(autoSavedData); app.navigateToStep(1); } }] }); } else { ui.populateForm(sessionData); app.navigateToStep(1); } },
        clearForm() { document.getElementById('welcome-message').classList.add('hidden'); document.getElementById('form-wrapper').classList.remove('hidden'); document.getElementById('action-buttons').classList.remove('hidden'); state.currentSessionId = null; state.maxStepReached = 1; document.getElementById('export-calendar-btn').disabled = true; ui.ensureEditorsInitialized(config.allEditorIds); document.querySelectorAll('#session-list > div').forEach(div => div.classList.remove('bg-blue-100', 'border-blue-500')); const autoSavedDataRaw = localStorage.getItem('autosave_new'); if (autoSavedDataRaw) { const autoSavedData = JSON.parse(autoSavedDataRaw); ui.showModal('Restaurar Borrador', 'Se ha encontrado un borrador no guardado. ¿Quieres restaurarlo?', { buttons: [{ text: 'No, empezar de cero', class: 'bg-slate-500', callback: () => { localStorage.removeItem('autosave_new'); ui.populateForm({}); app.navigateToStep(1); } }, { text: 'Sí, restaurar', class: 'bg-blue-500', callback: () => { ui.populateForm(autoSavedData); app.navigateToStep(1); } }] }); } else { ui.populateForm({}); app.navigateToStep(1); } },
        getFormData() { const form = document.getElementById('session-form'); const data = { id: state.currentSessionId }; const formFields = ['fecha', 'competenciaEspecifica', 'descriptoresOperativos', 'competenciasClave']; const multiSelectFields = ['materia', 'curso', 'sesionNum', 'tiposEvaluacion', 'contenidosTransversales', 'contenidos', 'unidadDidactica']; const editorFields = config.allEditorIds; formFields.forEach(id => { if (form.elements[id]) { data[id] = form.elements[id].value; } }); multiSelectFields.forEach(id => { if (form.elements[id]) { data[id] = JSON.parse(form.elements[id].value || '[]'); } }); editorFields.forEach(id => { if (state.editors[id] && state.editors[id].core) { data[id] = state.editors[id].getContents(true); } }); data.criteriosEvaluacion = Array.from(document.querySelectorAll('input[name="criteriosEvaluacion"]:checked')).map(cb => cb.value); data.dua = Array.from(document.querySelectorAll('input[name="dua"]:checked')).map(cb => cb.value); data.duaGuidelines = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]'); return data; },
        async saveSession() { const data = app.getFormData(); ui.showModal('Guardando...', '', { showSpinner: true, buttons: [] }); try { const r = await api.call('saveSession', { data }); const savedId = r.id; localStorage.removeItem(`autosave_${state.currentSessionId || 'new'}`); if (state.currentSessionId === null) localStorage.removeItem('autosave_new'); state.currentSessionId = savedId; state.maxStepReached = 5; document.getElementById('autosave-status').textContent = ''; document.getElementById('autosave-status').classList.add('opacity-0'); ui.showModal('Éxito', '¡Sesión guardada correctamente!'); await app.loadSessions(); ui.renderSessionList(); ui.updateStepNavigator(); document.getElementById('export-calendar-btn').disabled = !data.fecha; } catch (error) { console.error('Error al guardar', error); ui.showModal('Error', `Hubo un problema al guardar la sesión: ${error.message}`); } },
        async deleteSession() { if (!state.currentSessionId) return; ui.showModal('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar esta sesión?', { buttons: [{ text: 'Cancelar', class: 'bg-slate-500 hover:bg-slate-600', callback: ui.hideModal }, { text: 'Sí, Eliminar', class: 'bg-red-500 hover:bg-red-600', callback: async () => { ui.showModal('Eliminando...', '', { showSpinner: true, buttons: [] }); try { await api.call('deleteSession', { id: state.currentSessionId }); localStorage.removeItem(`autosave_${state.currentSessionId}`); document.getElementById('form-wrapper').classList.add('hidden'); document.getElementById('welcome-message').classList.remove('hidden'); ui.showModal('Éxito', 'Sesión eliminada.'); await app.loadSessions(); } catch (error) { console.error('Error al eliminar', error); ui.showModal('Error', `No se pudo eliminar la sesión: ${error.message}`); } } }] }); },
        duplicateSession() { if (!state.currentSessionId) { ui.showModal('Aviso', 'Por favor, selecciona una sesión para duplicar.'); return; } const s = state.allSessions.find(x => x.id === state.currentSessionId); if (!s) return; app.clearForm(); ui.populateForm(s); state.currentSessionId = null; state.maxStepReached = 5; document.getElementById('export-calendar-btn').disabled = !s.fecha; const titleContent = state.editors['situacionAprendizaje'].getContents(true); state.editors['situacionAprendizaje'].setContents(`[COPIA] ${titleContent}`); app.navigateToStep(1); ui.showModal('Sesión Duplicada', 'Se han copiado los datos. Revisa la información y pulsa "Guardar" para crear la nueva sesión.'); },
        handleSearch(event) { event.preventDefault(); const form = document.getElementById('search-form'); const filters = { materia: Array.from(form.elements['materia'].selectedOptions).map(o => o.value), curso: Array.from(form.elements['curso'].selectedOptions).map(o => o.value), sesionNum: Array.from(form.elements['sesionNum'].selectedOptions).map(o => o.value), situacionAprendizaje: form.elements['situacionAprendizaje'].value.toLowerCase(), fechaDesde: form.elements['fechaDesde'].value, fechaHasta: form.elements['fechaHasta'].value }; const filteredSessions = state.allSessions.filter(session => { const titleMatch = !filters.situacionAprendizaje || (session.situacionAprendizaje || '').toLowerCase().includes(filters.situacionAprendizaje); const materiaMatch = filters.materia.length === 0 || (session.materia || []).some(m => filters.materia.includes(m)); const cursoMatch = filters.curso.length === 0 || (session.curso || []).some(c => filters.curso.includes(c)); const sesionMatch = filters.sesionNum.length === 0 || (session.sesionNum || []).some(s => filters.sesionNum.includes(s)); const sessionDate = session.fecha; let dateMatch = true; if (filters.fechaDesde && sessionDate) { dateMatch = dateMatch && (sessionDate >= filters.fechaDesde); } if (filters.fechaHasta && sessionDate) { dateMatch = dateMatch && (sessionDate <= filters.fechaHasta); } if ((filters.fechaDesde || filters.fechaHasta) && !sessionDate) { dateMatch = false; } return titleMatch && materiaMatch && cursoMatch && sesionMatch && dateMatch; }); ui.renderSessionList(filteredSessions); ui.hideSearchModal(); },
        clearSearch() { document.getElementById('search-form').reset(); ui.renderSessionList(); },
        downloadFile(filename, content) { const element = document.createElement('a'); element.setAttribute('href', 'data:text/calendar;charset=utf-8,' + encodeURIComponent(content)); element.setAttribute('download', filename); element.style.display = 'none'; document.body.appendChild(element); element.click(); document.body.removeChild(element); },
        handleCalendarExport() { if (!state.currentSessionId) { ui.showModal('Error', 'No hay ninguna sesión seleccionada para exportar.'); return; } const session = state.allSessions.find(s => s.id === state.currentSessionId); if (!session.fecha) { ui.showModal('Sin Fecha', 'Esta sesión no tiene una fecha asignada. Por favor, añade una fecha para poder exportarla al calendario.'); return; } const icsData = calendar.generateICS(session); if (icsData) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = session.situacionAprendizaje || ''; const title = (tempDiv.textContent.split('\n')[0] || 'sesion').replace(/[^a-z0-9]/gi, '_').toLowerCase(); const filename = `${title}.ics`; app.downloadFile(filename, icsData); } else { ui.showModal('Error', 'No se pudo generar el archivo del calendario.'); } },
        saveDuaGuidelines() { const newly = Array.from(document.querySelectorAll('#dua-modal-content input[type="checkbox"]:checked')).map(cb => cb.value); const prev = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]'); const currentGroup = config.duaData[state.currentDuaPrincipleKey].guidelines.map(g => g.text); const other = prev.filter(t => !currentGroup.includes(t)); document.getElementById('selectedDuaGuidelines').value = JSON.stringify([...other, ...newly]); app.triggerAutoSave(); ui.hideDuaModal(); },
        saveMultiSelect() { const type = state.currentMultiSelect; if (!type) return; const selectedValues = Array.from(document.querySelectorAll(`#multi-select-modal-content input[type="checkbox"]:checked`)).map(cb => cb.value); document.getElementById(type).value = JSON.stringify(selectedValues); ui.updateChipsDisplay(type, selectedValues); app.triggerAutoSave(); ui.hideMultiSelectModal(); },
        triggerAutoSave() { const statusEl = document.getElementById('autosave-status'); statusEl.textContent = 'Guardando...'; statusEl.classList.remove('opacity-0'); clearTimeout(state.autoSaveTimer); state.autoSaveTimer = setTimeout(() => { const data = app.getFormData(); const key = `autosave_${state.currentSessionId || 'new'}`; localStorage.setItem(key, JSON.stringify(data)); statusEl.textContent = 'Guardado ✓'; setTimeout(() => statusEl.classList.add('opacity-0'), 2000); }, 1500); },
        init() {
            bank.load();
            ui.buildForm();
            document.getElementById('form-wrapper').classList.add('hidden');
            if (config.SCRIPT_URL.includes('PASTE_YOUR_URL_HERE')) { ui.showModal('Configuración Requerida', 'Debes editar el archivo HTML y pegar la URL de tu script de Google para que la aplicación funcione.'); } else { app.loadSessions(); }
            document.getElementById('new-session-btn').addEventListener('click', app.clearForm);
            document.getElementById('dashboard-new-session-btn').addEventListener('click', app.clearForm);
            document.getElementById('save-btn').addEventListener('click', app.saveSession);
            document.getElementById('delete-btn').addEventListener('click', app.deleteSession);
            document.getElementById('print-btn').addEventListener('click', ui.printReport);
            document.getElementById('duplicate-btn').addEventListener('click', app.duplicateSession);
            document.getElementById('export-calendar-btn').addEventListener('click', app.handleCalendarExport);
            document.getElementById('dua-modal-cancel').addEventListener('click', ui.hideDuaModal);
            document.getElementById('dua-modal-save').addEventListener('click', app.saveDuaGuidelines);
            document.getElementById('search-session-btn').addEventListener('click', ui.showSearchModal);
            document.getElementById('search-cancel-btn').addEventListener('click', ui.hideSearchModal);
            document.getElementById('search-form').addEventListener('submit', app.handleSearch);
            document.getElementById('search-clear-btn').addEventListener('click', app.clearSearch);
            document.getElementById('ud-modal-cancel')?.addEventListener('click', ui.hideUdModal);
            document.getElementById('multi-select-modal-cancel').addEventListener('click', ui.hideMultiSelectModal);
            document.getElementById('multi-select-modal-save').addEventListener('click', app.saveMultiSelect);
            document.getElementById('bank-modal-close').addEventListener('click', ui.hideBankModal);
            document.getElementById('form-container').addEventListener('click', (e) => {
                const saveBtn = e.target.closest('.js-bank-save');
                if (saveBtn) {
                    const { type, editor } = saveBtn.dataset;
                    const content = state.editors[editor].getContents(true);
                    if (!content || content === '<p><br></p>') { ui.showModal('Contenido vacío', 'No puedes guardar un recurso vacío en el banco.'); return; }
                    ui.prompt('Guardar Recurso', 'Dale un título a este recurso para encontrarlo fácilmente más tarde.', (title) => { if (title) { bank.addItem(type, title, content); ui.showModal('Éxito', '¡Recurso guardado en tu banco!'); } });
                }
                const importBtn = e.target.closest('.js-bank-import');
                if (importBtn) { const { type, editor } = importBtn.dataset; ui.showBankModal(type, editor); }
            });
            document.getElementById('session-form').addEventListener('click', (e) => { const trigger = e.target.closest('[data-modal-trigger]'); if (trigger) { const type = trigger.dataset.modalTrigger; if (type === 'ud') { ui.showUdModal(); } else { ui.showMultiSelectModal(type); } } });
            document.getElementById('step-navigator').addEventListener('click', e => { const stepEl = e.target.closest('.step-item'); if (stepEl && !stepEl.classList.contains('step-disabled')) { const step = parseInt(stepEl.dataset.step); app.navigateToStep(step); } });
        }
    };
    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>
