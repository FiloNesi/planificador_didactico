<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Planificador Didáctico de Filosofía</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    select[multiple] { padding: 0.5rem; }
    .checkbox-group { max-height: 20rem; }
    .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Estilos para la impresión */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        -webkit-print-color-adjust: exact; /* Para que se impriman los colores de fondo */
        color-adjust: exact;
      }
      .no-print { display: none; }
    }
    /* Clases de Prosa para Tailwind, para el contenido del informe */
    .prose { color: #334155; max-width: 65ch; }
    .prose a { color: #4f46e5; text-decoration: underline; }
    .prose strong { color: #1e293b; font-weight: 600; }
    .prose blockquote { border-left-color: #e2e8f0; }
    .prose thead { border-bottom-color: #e2e8f0; }
    .prose-sm { font-size: 0.875rem; line-height: 1.5; }
  </style>
</head>
<body class="bg-slate-100 text-slate-800">
  <div id="app-container" class="flex flex-col h-screen">
    <header class="bg-white shadow-md p-4 flex justify-between items-center no-print">
      <h1 class="text-2xl font-bold text-slate-700">Planificador Didáctico</h1>
    </header>
    <main class="flex-grow flex flex-col md:flex-row gap-4 p-4 overflow-hidden no-print">
      <aside class="w-full md:w-1/3 lg:w-1/4 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-4 border-b flex justify-between items-center gap-2">
          <h2 class="text-lg font-semibold">Sesiones</h2>
          <div class="flex gap-2">
            <button id="search-session-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold p-2 rounded-lg transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
            </button>
            <button id="new-session-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Nueva</button>
          </div>
        </div>
        <div id="session-list" class="overflow-y-auto flex-grow p-2">
          <div id="loading-sessions" class="p-4 text-center text-slate-500">Cargando sesiones...</div>
        </div>
      </aside>
      <section class="w-full md:w-2/3 lg:w-3/4 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
        <div id="form-header" class="p-4 border-b flex justify-between items-center flex-wrap gap-2">
          <h2 id="form-title" class="text-lg font-semibold">Selecciona una sesión o crea una nueva</h2>
          <div id="action-buttons" class="flex gap-2 hidden">
            <button id="save-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar</button>
            <button id="duplicate-btn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Duplicar</button>
            <button id="print-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Imprimir</button>
            <button id="delete-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Eliminar</button>
          </div>
        </div>
        <div id="form-container" class="overflow-y-auto flex-grow p-4">
          <form id="session-form"></form>
          <div id="welcome-message" class="text-center text-slate-500 p-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            <p class="mt-4 text-lg">Haz clic en "Nueva" para empezar a planificar tu primera sesión.</p>
          </div>
        </div>
      </section>
    </main>
  </div>
  <div id="print-area"></div>

  <!-- Modal genérico -->
  <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3 mx-auto flex flex-col items-center text-center">
      <div id="modal-spinner" class="spinner hidden mb-4"></div>
      <h3 id="modal-title" class="text-xl font-bold text-slate-800"></h3>
      <p id="modal-text" class="py-4 text-slate-600"></p>
      <div id="modal-buttons" class="text-right space-x-2"></div>
    </div>
  </div>

  <!-- Modal DUA -->
  <div id="dua-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 mx-auto">
      <h3 id="dua-modal-title" class="text-xl font-bold text-slate-800"></h3>
      <div id="dua-modal-content" class="py-4 space-y-2 max-h-96 overflow-y-auto"></div>
      <div id="dua-modal-buttons" class="text-right space-x-2">
        <button id="dua-modal-cancel" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
        <button id="dua-modal-save" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Guardar Pautas</button>
      </div>
    </div>
  </div>
  
  <!-- Modal Búsqueda -->
  <div id="search-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 no-print">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 mx-auto">
        <h3 class="text-xl font-bold text-slate-800 mb-4">Buscar Sesiones</h3>
        <form id="search-form" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="search-materia" class="block text-sm font-medium text-slate-700 mb-1">Materia</label>
                    <select id="search-materia" name="materia" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div>
                    <label for="search-curso" class="block text-sm font-medium text-slate-700 mb-1">Curso</label>
                    <select id="search-curso" name="curso" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                 <div>
                    <label for="search-sesion" class="block text-sm font-medium text-slate-700 mb-1">Sesión</label>
                    <select id="search-sesion" name="sesionNum" multiple class="w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                </div>
                <div>
                    <label for="search-titulo" class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                    <input type="text" id="search-titulo" name="situacionAprendizaje" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Contiene el texto...">
                </div>
                <!-- NUEVO: Campos de rango de fechas -->
                <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="search-fecha-desde" class="block text-sm font-medium text-slate-700 mb-1">Fecha Desde</label>
                        <input type="date" id="search-fecha-desde" name="fechaDesde" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="search-fecha-hasta" class="block text-sm font-medium text-slate-700 mb-1">Fecha Hasta</label>
                        <input type="date" id="search-fecha-hasta" name="fechaHasta" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 pt-4 border-t">
                <button id="search-clear-btn" type="button" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Limpiar</button>
                <button id="search-cancel-btn" type="button" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                <button id="search-submit-btn" type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">Buscar</button>
            </div>
        </form>
    </div>
  </div>


  <script type="module">
    // =============================
    // Config
    // =============================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyIClBck1KBGo7S4K3Hop1rkmSBNXjfP6MZ8Rsu714E_PIlNiZuimJfkH_j95HGKmSIZQ/exec";

    const evaluationData = [
      { id: "1.1", text: "1.1 Construir y expresar un concepto ajustado de sí mismo reconociendo las múltiples dimensiones de su naturaleza y personalidad, así como de la dimensión cívica y moral de la misma, a partir de la investigación y el diálogo en torno a diversas concepciones sobre la naturaleza humana.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
      { id: "1.2", text: "1.2 Identificar, gestionar y comunicar ideas, emociones, afectos y deseos con comprensión y empatía hacia las demás personas, demostrando autoestima y compartiendo un concepto adecuado de lo que deben ser las relaciones con otras personas, incluyendo el ámbito afectivo-sexual.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
      { id: "1.3", text: "1.3 Desarrollar y demostrar autonomía moral a través de la práctica de la deliberación racional, el uso de conceptos éticos, y el diálogo respetuoso con los demás en torno a distintos valores y modos de vida, así como a problemas relacionados con el ejercicio de los derechos individuales, el uso responsable y seguro de las redes, las conductas adictivas y el acoso escolar.", cesp: "CESP1", descriptores: ["CCL2", "CPSAA1", "CC1", "CC2", "CC3"], claves: ["CCL", "CPSAA", "CC"] },
      { id: "2.1", text: "2.1 Promover y demostrar una convivencia pacífica, respetuosa, democrática y comprometida con el bien común, a partir de la investigación sobre la naturaleza social y política del ser humano y el uso y comprensión crítica de los conceptos de ley, poder, soberanía, justicia, Estado, democracia, memoria democrática, dignidad y derechos humanos.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
      { id: "2.2", text: "2.2 Fomentar el ejercicio de la ciudadanía activa y democrática a través del conocimiento del movimiento asociativo y la participación respetuosa, dialogante y constructiva en actividades de grupo que impliquen tomar decisiones colectivas, planificar acciones coordinadas y resolver problemas aplicando procedimientos y principios cívicos, éticos y democráticos explícitos.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
      { id: "2.3", text: "2.3 Contribuir a generar un compromiso activo con el bien común a través del análisis y la toma razonada y dialogante de posición en torno a cuestiones éticas de actualidad como la lucha contra la desigualdad y la pobreza, el derecho al trabajo, la salud, la educación y la justicia, así como sobre los fines y límites éticos de la investigación científica.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
      { id: "2.4", text: "2.4 Tomar consciencia de la lucha por una efectiva igualdad de género, y del problema de la violencia y explotación sobre las mujeres, a través del análisis de las diversas olas y corrientes del feminismo y de las medidas de prevención de la desigualdad, la violencia y la discriminación por razón de género y orientación sexual, mostrando igualmente conocimiento de los derechos LGTBIQ+ y reconociendo la necesidad de respetarlos.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
      { id: "2.5", text: "2.5 Contribuir activamente al bienestar social adoptando una posición propia, explícita, informada y éticamente fundamentada sobre el valor y pertinencia de los derechos humanos, el respeto por la diversidad etnocultural, la consideración de los bienes públicos globales y la percepción del valor social de los impuestos.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
      { id: "2.6", text: "2.6 Contribuir a la consecución de un mundo más justo y pacífico a través del análisis y reconocimiento de la historia democrática de nuestro país y de las funciones del Estado de derecho y sus instituciones, los organismos internacionales, las asociaciones civiles y los cuerpos y fuerzas de seguridad del Estado, en su empeño por lograr la paz y la seguridad integral, atender a las víctimas de la violencia y promover la solidaridad y cooperación entre las personas y los pueblos.", cesp: "CESP2", descriptores: ["CCL5", "CD3", "CC1", "CC2", "CC3", "CC4", "CCEC1"], claves: ["CCL", "CD", "CC", "CCEC"] },
      { id: "3.1", text: "3.1 Describir las relaciones históricas de interconexión, interdependencia y ecodependencia entre nuestras vidas y el entorno a partir del análisis de las causas y consecuencias de los más graves problemas ecosociales que nos afectan.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },
      { id: "3.2", text: "3.2 Valorar distintos planteamientos científicos, políticos y éticos con los que afrontar la emergencia climática y la crisis medioambiental a través de la exposición y el debate argumental en torno a los mismos.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },
      { id: "3.3", text: "3.3 Promover estilos de vida éticamente comprometidos con el logro de un desarrollo sostenible, contribuyendo por sí mismo y en su entorno a la prevención de los residuos, la gestión sostenible de los recursos, la movilidad segura, sostenible y saludable, el comercio justo, el consumo responsable, el cuidado del patrimonio natural, el respeto por la diversidad etnocultural, y el cuidado y protección de los animales.", cesp: "CESP3", descriptores: ["STEM5", "CPSAA2", "CC1", "CC2", "CC3", "CC4", "CE1"], claves: ["STEM", "CPSAA", "CC", "CE"] },
      { id: "4.1", text: "4.1 Desarrollar una actitud de gestión equilibrada de las emociones, de estima y cuidado de sí mismo y de los otros, identificando, analizando y expresando de manera asertiva las propias emociones y sentimientos, y reconociendo y valorando los de los demás en distintos contextos y en torno a actividades creativas y de reflexión individual o dialogada sobre cuestiones éticas y cívicas.", cesp: "CESP4", descriptores: ["CCL1", "CPSAA1", "CPSAA2", "CPSAA3", "CC1", "CC3", "CCEC3"], claves: ["CCL", "CPSAA", "CC", "CCEC"] }
    ];

    const duaData = {
      principle1: { title: "I. Proporcionar múltiples medios de representación", guidelines: [
        { id: '1.1', text: 'Pauta 1.1: Ofrecer opciones para la percepción' },
        { id: '1.2', text: 'Pauta 1.2: Ofrecer opciones para el lenguaje y los símbolos' },
        { id: '1.3', text: 'Pauta 1.3: Ofrecer opciones para la comprensión' }
      ]},
      principle2: { title: "II. Proporcionar múltiples medios de acción y expresión", guidelines: [
        { id: '2.1', text: 'Pauta 4: Ofrecer opciones para la acción física' },
        { id: '2.2', text: 'Pauta 5: Ofrecer opciones para la expresión y la comunicación' },
        { id: '2.3', text: 'Pauta 6: Ofrecer opciones para las funciones ejecutivas' }
      ]},
      principle3: { title: "III. Proporcionar múltiples formas de implicación", guidelines: [
        { id: '3.1', text: 'Pauta 7: Ofrecer opciones para captar el interés' },
        { id: '3.2', text: 'Pauta 8: Ofrecer opciones para mantener el esfuerzo y la persistencia' },
        { id: '3.3', text: 'Pauta 9: Ofrecer opciones para la autorregulación' }
      ]}
    };

    const appData = {
      materias: ["Filosofía","Hª de la Filosofía","Valores Éticos","Psicología"],
      cursos: ["1º ESO","2º ESO","3º ESO","4º ESO","1º Bachillerato","2º Bachillerato"],
      sesiones: Array.from({length:25},(_,i)=>`Sesión ${i+1}`),
      metodologias: ["Aprendizaje Basado en Proyectos (ABP)","Flipped Classroom","Gamificación","Aprendizaje Cooperativo","Clase Magistral Interactiva","Debate Dirigido"],
      tiposEvaluacion: ["Diagnóstica","Formativa","Sumativa","Autoevaluación","Coevaluación"],
      criteriosCalificacion: ["Examen escrito (40%)","Trabajo de investigación (30%)","Participación en clase (10%)","Portfolio (20%)"],
      adaptaciones: ["Adaptación curricular no significativa","Adaptación curricular significativa","Actividades de ampliación","Actividades de refuerzo"],
      contenidosTransversales: ["Educación para la paz","Educación para la igualdad de género","Educación ambiental","Educación para la salud"]
    };

    let currentSessionId = null;
    let currentDuaPrincipleKey = null;
    let allSessions = [];

    // =============================
    // Modales
    // =============================
    function showModal(title, text, options = {}){
      const { showSpinner=false, buttons=[{text:'OK', class:'bg-blue-500', callback: hideModal}] } = options;
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-text').textContent = text;
      document.getElementById('modal-spinner').style.display = showSpinner ? 'block' : 'none';
      const buttonsContainer = document.getElementById('modal-buttons');
      buttonsContainer.innerHTML = '';
      buttons.forEach(info => {
        const b = document.createElement('button');
        b.textContent = info.text;
        b.className = `text-white font-bold py-2 px-4 rounded-lg transition-colors ${info.class}`;
        b.addEventListener('click', ()=>{ hideModal(); if (info.callback) info.callback(); });
        buttonsContainer.appendChild(b);
      });
      document.getElementById('modal').classList.remove('hidden');
    }
    function hideModal(){ document.getElementById('modal').classList.add('hidden'); }

    // =============================
    // DUA Modal
    // =============================
    function showDuaModal(principleKey){
      currentDuaPrincipleKey = principleKey;
      const principle = duaData[principleKey];
      document.getElementById('dua-modal-title').textContent = principle.title;
      const content = document.getElementById('dua-modal-content');
      content.innerHTML = '';
      const saved = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
      principle.guidelines.forEach(g => {
        const row = document.createElement('div'); row.className = 'flex items-center';
        const cb = document.createElement('input'); cb.type='checkbox'; cb.id=`dua-guideline-${g.id}`; cb.value=g.text; cb.checked=saved.includes(g.text); cb.className='h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
        const label = document.createElement('label'); label.htmlFor=cb.id; label.textContent=g.text; label.className='ml-3 text-sm text-slate-600';
        row.appendChild(cb); row.appendChild(label); content.appendChild(row);
      });
      document.getElementById('dua-modal').classList.remove('hidden');
    }
    function hideDuaModal(){ currentDuaPrincipleKey=null; document.getElementById('dua-modal').classList.add('hidden'); }
    function saveDuaGuidelines(){
      const newly = Array.from(document.querySelectorAll('#dua-modal-content input[type="checkbox"]:checked')).map(cb=>cb.value);
      const prev = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
      const currentGroup = duaData[currentDuaPrincipleKey].guidelines.map(g=>g.text);
      const other = prev.filter(t=>!currentGroup.includes(t));
      document.getElementById('selectedDuaGuidelines').value = JSON.stringify([...other, ...newly]);
      hideDuaModal();
    }
    
    // =============================
    // Search Modal
    // =============================
    function showSearchModal() {
        const populateSelect = (selectId, data) => {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            data.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt;
                o.textContent = opt;
                select.appendChild(o);
            });
        };
        populateSelect('search-materia', appData.materias);
        populateSelect('search-curso', appData.cursos);
        populateSelect('search-sesion', appData.sesiones);
        document.getElementById('search-modal').classList.remove('hidden');
    }

    function hideSearchModal() {
        document.getElementById('search-modal').classList.add('hidden');
    }

    function handleSearch(event) {
        event.preventDefault();
        const form = document.getElementById('search-form');
        const filters = {
            materia: Array.from(form.elements['materia'].selectedOptions).map(o => o.value),
            curso: Array.from(form.elements['curso'].selectedOptions).map(o => o.value),
            sesionNum: Array.from(form.elements['sesionNum'].selectedOptions).map(o => o.value),
            situacionAprendizaje: form.elements['situacionAprendizaje'].value.toLowerCase(),
            fechaDesde: form.elements['fechaDesde'].value, // NUEVO
            fechaHasta: form.elements['fechaHasta'].value  // NUEVO
        };

        const filteredSessions = allSessions.filter(session => {
            const titleMatch = !filters.situacionAprendizaje || (session.situacionAprendizaje || '').toLowerCase().includes(filters.situacionAprendizaje);
            const materiaMatch = filters.materia.length === 0 || (session.materia || []).some(m => filters.materia.includes(m));
            const cursoMatch = filters.curso.length === 0 || (session.curso || []).some(c => filters.curso.includes(c));
            const sesionMatch = filters.sesionNum.length === 0 || (session.sesionNum || []).some(s => filters.sesionNum.includes(s));
            
            // NUEVO: Lógica de filtrado por fecha
            const sessionDate = session.fecha;
            let dateMatch = true;
            if (filters.fechaDesde && sessionDate) {
                dateMatch = dateMatch && (sessionDate >= filters.fechaDesde);
            }
            if (filters.fechaHasta && sessionDate) {
                dateMatch = dateMatch && (sessionDate <= filters.fechaHasta);
            }
            if ((filters.fechaDesde || filters.fechaHasta) && !sessionDate) {
                dateMatch = false; // Si se filtra por fecha, las sesiones sin fecha no aparecen
            }

            return titleMatch && materiaMatch && cursoMatch && sesionMatch && dateMatch;
        });

        renderSessionList(filteredSessions);
        hideSearchModal();
    }
    
    function clearSearch() {
        document.getElementById('search-form').reset();
        renderSessionList(); // Render all sessions
    }


    // =============================
    // Form helpers
    // =============================
    function createFormField(id, label, type, options = []){
      const wrapper = document.createElement('div');
      const labelEl = document.createElement('label');
      labelEl.setAttribute('for', id);
      labelEl.className = 'block text-sm font-medium text-slate-700 mb-1';
      labelEl.textContent = label;
      wrapper.appendChild(labelEl);

      let field;
      if (type === 'textarea'){
        field = document.createElement('textarea'); field.rows = 3;
        field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500';
      } else if (type === 'date') {
        field = document.createElement('input');
        field.type = 'date';
        field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500';
      } else if (type === 'readonly-textarea'){
        field = document.createElement('textarea'); field.rows = 3; field.readOnly = true;
        field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm bg-slate-100 focus:ring-0 focus:border-slate-300 cursor-not-allowed';
      } else if (type === 'select-multiple'){
        field = document.createElement('select'); field.multiple = true;
        field.className = 'w-full p-2 h-32 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500';
        options.forEach(opt => { const o=document.createElement('option'); o.value=opt; o.textContent=opt; field.appendChild(o); });
      } else if (type === 'checkbox-group'){
        field = document.createElement('div'); field.className = 'w-full p-2 border border-slate-300 rounded-md shadow-sm overflow-y-auto checkbox-group';
        options.forEach(opt => {
          const row = document.createElement('div'); row.className='flex items-start my-2';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.id=`${id}-${opt.id}`; cb.name=id; cb.value=opt.text; cb.className='h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-1 flex-shrink-0';
          const lab = document.createElement('label'); lab.htmlFor=cb.id; lab.textContent=opt.text; lab.className='ml-3 text-sm text-slate-600';
          row.appendChild(cb); row.appendChild(lab); field.appendChild(row);
        });
      } else if (type === 'dua-group'){
        field = document.createElement('div'); field.className='w-full p-2 border border-slate-300 rounded-md shadow-sm space-y-3';
        const hidden = document.createElement('input'); hidden.type='hidden'; hidden.id='selectedDuaGuidelines'; field.appendChild(hidden);
        Object.entries(duaData).forEach(([key, value]) => {
          const item = document.createElement('div'); item.className='flex items-center justify-between';
          const left = document.createElement('div'); left.className='flex items-center';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.id=`dua-${key}`; cb.name='dua'; cb.value=value.title; cb.className='h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
          const lab = document.createElement('label'); lab.htmlFor=cb.id; lab.textContent=value.title; lab.className='ml-3 text-sm text-slate-600';
          left.appendChild(cb); left.appendChild(lab); item.appendChild(left);
          if (value.guidelines.length){
            const btn = document.createElement('button'); btn.type='button'; btn.textContent='Seleccionar Pautas'; btn.className='text-sm bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-1 px-3 rounded-lg transition-colors';
            btn.addEventListener('click', ()=>showDuaModal(key)); item.appendChild(btn);
          }
          field.appendChild(item);
        });
      }
      field.id = id; if (type !== 'checkbox-group' && type !== 'dua-group') field.name = id;
      wrapper.appendChild(field);
      return wrapper;
    }

    function updateDerivedFields(){
      const selected = Array.from(document.querySelectorAll('input[name="criteriosEvaluacion"]:checked')).map(cb=>cb.value);
      const allCesp = new Set(), allDes = new Set(), allClaves = new Set();
      evaluationData.forEach(c => { if (selected.includes(c.text)){ allCesp.add(c.cesp); c.descriptores.forEach(d=>allDes.add(d)); c.claves.forEach(k=>allClaves.add(k)); } });
      document.getElementById('competenciaEspecifica').value = [...allCesp].join(', ');
      document.getElementById('descriptoresOperativos').value = [...allDes].join(', ');
      document.getElementById('competenciasClave').value = [...allClaves].join(', ');
    }

    // =============================
    // Resumen de Información General
    // =============================
    function chipsHtml(arr){ const a = Array.isArray(arr)?arr:[]; return a.length? a.map(v=>`<span class="inline-block text-xs bg-slate-100 border border-slate-200 rounded-full px-2 py-0.5 mr-1 mb-1">${String(v)}</span>`).join('') : '<span class="text-slate-400 text-sm">Sin seleccionar</span>'; }
    function renderInfoSummary(){
      const form = document.getElementById('session-form');
      const titleFull = (form.elements['situacionAprendizaje']?.value || '').trim();
      const title = titleFull.split('\n')[0] || 'Sesión sin título';
      const materia = Array.from(form.elements['materia']?.selectedOptions || []).map(o=>o.value);
      const curso = Array.from(form.elements['curso']?.selectedOptions || []).map(o=>o.value);
      const sesionNum = Array.from(form.elements['sesionNum']?.selectedOptions || []).map(o=>o.value);
      const fecha = form.elements['fecha']?.value;
      const formattedDate = fecha ? new Date(fecha).toLocaleDateString('es-ES') : '<span class="text-slate-400">Sin fecha</span>';

      const summary = document.getElementById('info-summary') || (()=>{ const d=document.createElement('div'); d.id='info-summary'; d.className='hidden mb-4'; document.getElementById('form-step-2')?.prepend(d); return d; })();
      summary.innerHTML = `
        <div class="border border-slate-200 rounded-lg p-4 bg-slate-50">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">Información general</h3>
            <button id="edit-info-btn" type="button" class="text-xs font-semibold text-blue-600 hover:underline">Editar</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
            <div class="lg:col-span-2"><div class="text-xs uppercase text-slate-500">Título</div><div class="text-sm text-slate-800">${title || '<span class="text-slate-400">Sin título</span>'}</div></div>
            <div><div class="text-xs uppercase text-slate-500">Materia(s)</div><div>${chipsHtml(materia)}</div></div>
            <div><div class="text-xs uppercase text-slate-500">Curso(s)</div><div>${chipsHtml(curso)}</div></div>
            <div><div class="text-xs uppercase text-slate-500">Sesión(es)</div><div>${chipsHtml(sesionNum)}</div></div>
            <div><div class="text-xs uppercase text-slate-500">Fecha</div><div class="text-sm text-slate-800">${formattedDate}</div></div>
          </div>
        </div>`;
      summary.classList.remove('hidden');
      document.getElementById('edit-info-btn')?.addEventListener('click', () => {
        document.getElementById('form-step-1').classList.remove('hidden');
        document.getElementById('form-step-2').classList.add('hidden');
        document.getElementById('continue-btn').classList.remove('hidden');
        document.getElementById('action-buttons').classList.add('hidden');
        document.getElementById('info-summary').classList.add('hidden');
        document.getElementById('form-title').textContent = 'Paso 1: Información General';
      }, { once: true });
    }

    // =============================
    // Construcción del formulario
    // =============================
    function buildForm(){
      const form = document.getElementById('session-form');
      form.innerHTML = '';
      const step1 = document.createElement('div'); step1.id='form-step-1'; step1.className='space-y-6';
      const step2 = document.createElement('div'); step2.id='form-step-2'; step2.className='hidden space-y-6';
      const fieldsets = [
        { step:1, legend: 'Información General', fields:[
          { id:'situacionAprendizaje', label:'Situación de Aprendizaje', type:'textarea' },
          { id:'fecha', label:'Fecha', type:'date' },
          { id:'materia', label:'Materia', type:'select-multiple', options: appData.materias },
          { id:'curso', label:'Curso', type:'select-multiple', options: appData.cursos },
          { id:'sesionNum', label:'Nº de la Sesión', type:'select-multiple', options: appData.sesiones },
        ]},
        { step:2, legend: 'Actividades', fields:[
          { id:'actividad1', label:'Actividad 1', type:'textarea' },
          { id:'actividad2', label:'Actividad 2', type:'textarea' },
          { id:'actividad3', label:'Actividad 3', type:'textarea' },
          { id:'actividad4', label:'Actividad 4', type:'textarea' },
        ]},
        { step:2, legend: 'Evaluación', fields:[
          { id:'criteriosEvaluacion', label:'Criterios de Evaluación', type:'checkbox-group', options: evaluationData },
          { id:'instrumentosEvaluacion', label:'Instrumentos de Evaluación', type:'textarea' },
          { id:'tiposEvaluacion', label:'Tipos de Evaluación', type:'select-multiple', options: appData.tiposEvaluacion },
          { id:'criteriosCalificacion', label:'Criterios de Calificación', type:'select-multiple', options: appData.criteriosCalificacion },
          { id:'recursos', label:'Recursos', type:'textarea' },
        ]},
        { step:2, legend: 'Marco Pedagógico (Automático)', fields:[
          { id:'competenciaEspecifica', label:'Competencia Específica', type:'readonly-textarea' },
          { id:'descriptoresOperativos', label:'Descriptores Operativos', type:'readonly-textarea' },
          { id:'competenciasClave', label:'Competencias Clave', type:'readonly-textarea' },
          { id:'contenidosTransversales', label:'Contenidos Transversales', type:'select-multiple', options: appData.contenidosTransversales },
        ]},
        { step:2, legend: 'Atención a la Diversidad', fields:[
          { id:'dua', label:'DUA', type:'dua-group' },
          { id:'adaptacion', label:'Adaptación', type:'select-multiple', options: appData.adaptaciones },
        ]},
        { step:2, legend: 'Observaciones', fields:[
          { id:'observaciones', label:'Observaciones y notas adicionales', type:'textarea' },
        ]},
      ];
      fieldsets.forEach(fs => {
        const fsEl = document.createElement('fieldset'); fsEl.className='border border-slate-200 p-4 rounded-lg';
        const legend = document.createElement('legend'); legend.className='text-md font-semibold px-2 text-slate-600'; legend.textContent=fs.legend; fsEl.appendChild(legend);
        const grid = document.createElement('div'); 
        grid.className = fs.fields.length > 2 ? 'grid grid-cols-1 md:grid-cols-2 gap-4' : 'grid grid-cols-1 gap-4';
        if (fs.legend === 'Información General') {
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            const saWrapper = createFormField('situacionAprendizaje', 'Situación de Aprendizaje', 'textarea');
            saWrapper.classList.add('md:col-span-2');
            grid.appendChild(saWrapper);
            grid.appendChild(createFormField('fecha', 'Fecha', 'date'));
            grid.appendChild(createFormField('materia', 'Materia', 'select-multiple', appData.materias));
            grid.appendChild(createFormField('curso', 'Curso', 'select-multiple', appData.cursos));
            grid.appendChild(createFormField('sesionNum', 'Nº de la Sesión', 'select-multiple', appData.sesiones));
        } else {
            fs.fields.forEach(f => grid.appendChild(createFormField(f.id, f.label, f.type, f.options)));
        }
        fsEl.appendChild(grid);
        (fs.step===1?step1:step2).appendChild(fsEl);
      });
      const continueBtn = document.createElement('button'); continueBtn.type='button'; continueBtn.id='continue-btn'; continueBtn.textContent='Continuar'; continueBtn.className='w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors'; step1.appendChild(continueBtn);
      const infoSummary = document.createElement('div'); infoSummary.id='info-summary'; infoSummary.className='hidden mb-4'; step2.prepend(infoSummary);
      form.appendChild(step1); form.appendChild(step2);
      form.addEventListener('change', (e)=>{ if (e.target.name==='criteriosEvaluacion') updateDerivedFields(); });
    }

    // =============================
    // API (anti CORS)
    // =============================
    async function apiCall(action, data={}){
      const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({ action, ...data }) });
      if (!res.ok) throw new Error(`Error de red: ${res.status} ${res.statusText}`);
      const text = await res.text();
      let result; try { result = JSON.parse(text); } catch { throw new Error(`Respuesta no JSON del servidor: ${text.slice(0,200)}`); }
      if (!result.success) throw new Error(result.message || 'Error desconocido en el servidor');
      return result.data;
    }

    // =============================
    // Datos
    // =============================
    async function loadSessions(){
      const loadingEl = document.getElementById('loading-sessions');
      loadingEl.textContent='Cargando sesiones...';
      try { allSessions = await apiCall('getSessions'); renderSessionList(); }
      catch (error){ console.error('Error detallado al cargar sesiones:', error); loadingEl.textContent='Error al cargar sesiones.'; showModal('Error de Conexión', `No se pudieron cargar las sesiones. Detalles: ${error.message}. Comprueba que el despliegue del script es "Anyone" y vuelve a desplegar tras cambios.`); }
    }

    function renderSessionList(sessionsToRender = allSessions){
      const sessionList = document.getElementById('session-list'); 
      const loadingEl = document.getElementById('loading-sessions');
      if (loadingEl) {
          loadingEl.style.display = 'none'; 
      }
      sessionList.innerHTML = '';
      if (!sessionsToRender.length){ 
          sessionList.innerHTML = '<p class="text-center text-slate-500 p-4">No se encontraron sesiones.</p>'; 
          return; 
      }
      sessionsToRender.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      sessionsToRender.forEach(session => {
        const div = document.createElement('div');
        div.className = `p-3 m-1 rounded-lg cursor-pointer border-l-4 transition-colors ${currentSessionId === session.id ? 'bg-blue-100 border-blue-500' : 'hover:bg-slate-100 border-transparent'}`;
        div.dataset.id = session.id;
        const title = session.situacionAprendizaje?.split('\n')[0] || 'Sin título';
        const subtitle = `${session.materia?.[0] || 'Sin materia'} - ${session.curso?.[0] || 'Sin curso'}`;
        div.innerHTML = `<h3 class=\"font-semibold truncate\">${title}</h3><p class=\"text-sm text-slate-500\">${subtitle}</p>`;
        div.addEventListener('click', ()=>displaySession(session.id)); sessionList.appendChild(div);
      });
    }

    function displaySession(sessionId){
      const sessionData = allSessions.find(s=>s.id===sessionId); if (!sessionData) return;
      document.getElementById('welcome-message').style.display = 'none';
      document.getElementById('session-form').style.display = 'block';
      document.getElementById('action-buttons').classList.remove('hidden');
      document.getElementById('form-step-1').classList.remove('hidden');
      document.getElementById('form-step-2').classList.remove('hidden');
      document.getElementById('continue-btn').classList.add('hidden');
      const form = document.getElementById('session-form'); form.reset(); currentSessionId = sessionData.id;
      const title = sessionData.situacionAprendizaje?.split('\n')[0] || 'Sesión sin título';
      document.getElementById('form-title').textContent = `Editando: ${title}`;
      document.querySelectorAll('#session-list > div').forEach(div => { div.classList.toggle('bg-blue-100', div.dataset.id===currentSessionId); div.classList.toggle('border-blue-500', div.dataset.id===currentSessionId); });
      for (const key in sessionData){
        const field = form.elements[key];
        if (field){
          if (field.multiple){ const values = Array.isArray(sessionData[key]) ? sessionData[key] : []; for (const opt of field.options) opt.selected = values.includes(opt.value); }
          else { field.value = sessionData[key] || ''; }
        } else if (key==='criteriosEvaluacion' || key==='dua'){
          const saved = Array.isArray(sessionData[key]) ? sessionData[key] : []; document.querySelectorAll(`input[name="${key}"]`).forEach(cb=>{ cb.checked = saved.includes(cb.value); });
        }
      }
      document.getElementById('selectedDuaGuidelines').value = JSON.stringify(sessionData.duaGuidelines || []);
      updateDerivedFields();
      renderInfoSummary();
      document.getElementById('form-step-1').classList.add('hidden');
      document.getElementById('form-step-2').classList.remove('hidden');
      document.getElementById('continue-btn').classList.add('hidden');
      document.getElementById('action-buttons').classList.remove('hidden');
    }

    function clearForm(){
      document.getElementById('welcome-message').style.display = 'none';
      document.getElementById('session-form').style.display = 'block';
      document.getElementById('action-buttons').classList.add('hidden');
      document.getElementById('form-step-1').classList.remove('hidden');
      document.getElementById('form-step-2').classList.add('hidden');
      document.getElementById('continue-btn').classList.remove('hidden');
      currentSessionId = null;
      const form = document.getElementById('session-form'); form.reset();
      const hiddenDUA = document.getElementById('selectedDuaGuidelines'); if (hiddenDUA) hiddenDUA.value = '[]';
      document.getElementById('form-title').textContent = 'Paso 1: Información General';
      document.querySelectorAll('#session-list > div').forEach(div => div.classList.remove('bg-blue-100','border-blue-500'));
      const summary = document.getElementById('info-summary'); if (summary){ summary.classList.add('hidden'); summary.innerHTML=''; }
      document.getElementById('situacionAprendizaje')?.focus();
    }

    async function saveSession(){
      const form = document.getElementById('session-form');
      const data = { id: currentSessionId };
      ['situacionAprendizaje','fecha','actividad1','actividad2','actividad3','actividad4','instrumentosEvaluacion','recursos','competenciaEspecifica','descriptoresOperativos','competenciasClave', 'observaciones'].forEach(id=>{ if (form.elements[id]) data[id] = form.elements[id].value; });
      ['materia','curso','sesionNum','tiposEvaluacion','criteriosCalificacion','contenidosTransversales','adaptacion'].forEach(id=>{ if (form.elements[id]) data[id] = Array.from(form.elements[id].selectedOptions).map(o=>o.value); });
      data.criteriosEvaluacion = Array.from(document.querySelectorAll('input[name="criteriosEvaluacion"]:checked')).map(cb=>cb.value);
      data.dua = Array.from(document.querySelectorAll('input[name="dua"]:checked')).map(cb=>cb.value);
      data.duaGuidelines = JSON.parse(document.getElementById('selectedDuaGuidelines').value || '[]');
      showModal('Guardando...', '', { showSpinner: true, buttons: [] });
      try { const r = await apiCall('saveSession', { data }); if (!currentSessionId) currentSessionId = r.id; showModal('Éxito','¡Sesión guardada correctamente!'); loadSessions(); }
      catch (error){ console.error('Error al guardar', error); showModal('Error', `Hubo un problema al guardar la sesión: ${error.message}`); }
    }

    async function deleteSession(){
      if (!currentSessionId) return;
      showModal('Confirmar Eliminación','¿Estás seguro de que quieres eliminar esta sesión?',{ buttons:[
        { text:'Cancelar', class:'bg-slate-500 hover:bg-slate-600', callback: hideModal },
        { text:'Sí, Eliminar', class:'bg-red-500 hover:bg-red-600', callback: async ()=>{
          showModal('Eliminando...', '', { showSpinner: true, buttons: [] });
          try { await apiCall('deleteSession',{ id: currentSessionId }); clearForm(); document.getElementById('session-form').style.display='none'; document.getElementById('welcome-message').style.display='block'; showModal('Éxito','Sesión eliminada.'); loadSessions(); }
          catch (error){ console.error('Error al eliminar', error); showModal('Error', `No se pudo eliminar la sesión: ${error.message}`); }
        }} ]});
    }

    function duplicateSession(){
      if (!currentSessionId){ showModal('Aviso','Por favor, selecciona una sesión para duplicar.'); return; }
      const s = allSessions.find(x=>x.id===currentSessionId); if (!s) return; clearForm(); displaySession(s.id); currentSessionId = null;
      const titleField = document.getElementById('situacionAprendizaje'); titleField.value = `[COPIA] ${titleField.value}`;
      document.getElementById('form-title').textContent = `Duplicando: ${s.situacionAprendizaje.split('\n')[0]}`;
      document.getElementById('form-step-2').classList.remove('hidden'); document.getElementById('continue-btn').classList.add('hidden'); document.getElementById('action-buttons').classList.remove('hidden');
      showModal('Sesión Duplicada','Se han copiado los datos. Revisa la información y pulsa "Guardar" para crear la nueva sesión.');
    }

    function printReport() {
        if (!currentSessionId) {
            showModal('Aviso', 'Por favor, guarda la sesión antes de imprimir.');
            return;
        }
        const data = allSessions.find(s => s.id === currentSessionId);
        if (!data) return;

        const printArea = document.getElementById('print-area');

        // --- Funciones de ayuda para construir el informe ---
        const createIcon = (path) => `<svg class="w-6 h-6 mr-3 text-indigo-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${path}</svg>`;

        const icons = {
            situacion: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),
            actividades: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.085a2 2 0 00-1.736.97l-1.9 3.8a2 2 0 00.23 2.16l3.5 3.5m7-10L7 5"></path>'),
            evaluacion: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),
            marco: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h1a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 16.95l.826.826m8.334-8.334l.826.826m-1.06-7.553l.267.267m-1.623 1.623l.267.267M16.95 7.737l.826.826M12 21a9 9 0 100-18 9 9 0 000 18z"></path>'),
            diversidad: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>'),
            info: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>'),
            observaciones: createIcon('<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.586a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>')
        };

        const createList = (items) => {
            if (!items || items.length === 0) return '<p class="text-slate-500 italic mt-2">No especificado</p>';
            return `<ul class="list-disc list-inside space-y-1 mt-2 pl-2">${items.map(i => `<li>${i}</li>`).join('')}</ul>`;
        };

        const createText = (content) => {
            if (!content || content.trim() === '') return '<p class="text-slate-500 italic mt-2">No especificado</p>';
            return `<div class="prose prose-sm max-w-none mt-2">${content.replace(/\n/g, '<br>')}</div>`;
        };

        const createCard = (title, icon, content) => `
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 print:shadow-none print:border print:border-slate-200">
                <div class="p-6">
                    <div class="flex items-center">
                        ${icon}
                        <h3 class="text-xl font-bold text-slate-800">${title}</h3>
                    </div>
                    <div class="mt-4 text-slate-600 pl-9">
                        ${content}
                    </div>
                </div>
            </div>
        `;

        const createSidebarCard = (title, icon, content) => `
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 print:shadow-none print:border print:border-slate-200">
                <div class="p-5">
                    <div class="flex items-center border-b border-slate-200 pb-3 mb-3">
                        ${icon}
                        <h4 class="text-md font-bold text-slate-700">${title}</h4>
                    </div>
                    <div class="text-sm text-slate-600">${content}</div>
                </div>
            </div>
        `;

        // --- Procesamiento de datos ---
        const situacion = data.situacionAprendizaje || '';
        const situacionTitle = situacion.split('\n')[0] || 'Situación de Aprendizaje sin Título';
        const situacionBody = situacion.substring(situacion.indexOf('\n') + 1);

        const actividadesContent = [data.actividad1, data.actividad2, data.actividad3, data.actividad4]
            .map((act, i) => act ? `<div><strong class="font-semibold text-slate-700">Actividad ${i + 1}:</strong>${createText(act)}</div>` : '')
            .filter(Boolean)
            .join('<hr class="my-4 border-slate-200">');

        const evaluacionContent = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><strong class="font-semibold text-slate-700">Criterios de Evaluación:</strong>${createList(data.criteriosEvaluacion)}</div>
                <div><strong class="font-semibold text-slate-700">Instrumentos:</strong>${createText(data.instrumentosEvaluacion)}</div>
                <div><strong class="font-semibold text-slate-700">Tipos de Evaluación:</strong>${createList(data.tiposEvaluacion)}</div>
                <div><strong class="font-semibold text-slate-700">Criterios de Calificación:</strong>${createList(data.criteriosCalificacion)}</div>
                <div class="md:col-span-2"><strong class="font-semibold text-slate-700">Recursos:</strong>${createText(data.recursos)}</div>
            </div>
        `;

        const marcoContent = `
            <strong class="font-semibold text-slate-700">Competencia Específica:</strong>${createText(data.competenciaEspecifica)}
            <hr class="my-3 border-slate-200">
            <strong class="font-semibold text-slate-700">Descriptores Operativos:</strong>${createText(data.descriptoresOperativos)}
            <hr class="my-3 border-slate-200">
            <strong class="font-semibold text-slate-700">Competencias Clave:</strong>${createText(data.competenciasClave)}
            <hr class="my-3 border-slate-200">
            <strong class="font-semibold text-slate-700">Contenidos Transversales:</strong>${createList(data.contenidosTransversales)}
        `;

        const duaGuidelines = data.duaGuidelines && data.duaGuidelines.length ? `<div><strong class="font-semibold text-slate-700 mt-4 block">Pautas Específicas:</strong>${createList(data.duaGuidelines)}</div>` : '';
        const diversidadContent = `
            <strong class="font-semibold text-slate-700">Principios DUA:</strong>${createList(data.dua)}
            ${duaGuidelines}
            <hr class="my-3 border-slate-200">
            <strong class="font-semibold text-slate-700">Adaptaciones:</strong>${createList(data.adaptacion)}
        `;
        
        const observacionesContent = data.observaciones && data.observaciones.trim() !== ''
            ? `<div class="prose prose-sm max-w-none mt-2">${data.observaciones.replace(/\n/g, '<br>')}</div>`
            : `<div class="h-48"></div>`;
        
        const fecha = data.fecha ? new Date(data.fecha).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }) : 'No especificada';
        const infoGeneralContent = `
            <strong class="font-semibold text-slate-700">Fecha:</strong><p class="mt-1 mb-3 pl-2">${fecha}</p>
            <strong class="font-semibold text-slate-700">Materia(s):</strong>${createList(data.materia)}
            <hr class="my-3 border-slate-200">
            <strong class="font-semibold text-slate-700">Curso(s):</strong>${createList(data.curso)}
            <hr class="my-3 border-slate-200">
            <strong class="font-semibold text-slate-700">Sesión(es):</strong>${createList(data.sesionNum)}
        `;

        // --- Estructura HTML del informe ---
        printArea.innerHTML = `
            <div class="p-8 bg-slate-50 font-sans">
                <header class="text-center mb-10">
                    <h1 class="text-4xl font-extrabold text-slate-800 tracking-tight">Programación de Sesión</h1>
                    <p class="mt-2 text-lg text-slate-500">Informe Detallado</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Columna principal -->
                    <main class="lg:col-span-2">
                        ${createCard('Situación de Aprendizaje', icons.situacion, `
                            <h2 class="text-2xl font-bold text-indigo-700">${situacionTitle}</h2>
                            <div class="prose prose-slate max-w-none mt-4">${situacionBody.replace(/\n/g, '<br>')}</div>
                        `)}
                        
                        ${createCard('Secuencia de Actividades', icons.actividades, actividadesContent || createText(null))}
                    </main>

                    <!-- Barra lateral -->
                    <aside>
                        ${createSidebarCard('Información General', icons.info, infoGeneralContent)}
                        ${createSidebarCard('Marco Pedagógico', icons.marco, marcoContent)}
                    </aside>
                </div>

                <!-- Secciones a todo lo ancho -->
                <div class="mt-2">
                    ${createCard('Estrategia de Evaluación', icons.evaluacion, evaluacionContent)}
                    ${createCard('Atención a la Diversidad', icons.diversidad, diversidadContent)}
                    ${createCard('Observaciones', icons.observaciones, observacionesContent)}
                </div>

                <footer class="text-center mt-10 pt-6 border-t border-slate-200">
                    <p class="text-sm text-slate-500">Informe generado con el Planificador Didáctico - ${new Date().toLocaleDateString('es-ES')}</p>
                </footer>
            </div>
        `;
        window.print();
    }


    // =============================
    // DOM Ready
    // =============================
    document.addEventListener('DOMContentLoaded', ()=>{
      buildForm();
      document.getElementById('session-form').style.display = 'none';
      if (SCRIPT_URL.includes('Pega aquí')){ showModal('Configuración Requerida','Debes editar el archivo HTML y pegar la URL de tu script de Google para que la aplicación funcione.'); document.getElementById('loading-sessions').textContent = 'Configuración requerida.'; }
      else { loadSessions(); }
      document.getElementById('new-session-btn').addEventListener('click', ()=>{ console.debug('Nueva clicada'); clearForm(); });
      document.getElementById('save-btn').addEventListener('click', saveSession);
      document.getElementById('delete-btn').addEventListener('click', deleteSession);
      document.getElementById('print-btn').addEventListener('click', printReport);
      document.getElementById('duplicate-btn').addEventListener('click', duplicateSession);
      document.getElementById('continue-btn').addEventListener('click', ()=>{ renderInfoSummary(); document.getElementById('form-step-1').classList.add('hidden'); document.getElementById('form-step-2').classList.remove('hidden'); document.getElementById('continue-btn').classList.add('hidden'); document.getElementById('action-buttons').classList.remove('hidden'); document.getElementById('form-title').textContent = 'Paso 2: Detalles de la Sesión'; });
      document.getElementById('dua-modal-cancel').addEventListener('click', hideDuaModal);
      document.getElementById('dua-modal-save').addEventListener('click', saveDuaGuidelines);
      
      // Listeners para la búsqueda
      document.getElementById('search-session-btn').addEventListener('click', showSearchModal);
      document.getElementById('search-cancel-btn').addEventListener('click', hideSearchModal);
      document.getElementById('search-form').addEventListener('submit', handleSearch);
      document.getElementById('search-clear-btn').addEventListener('click', clearSearch);

    });
  </script>
</body>
</html>
